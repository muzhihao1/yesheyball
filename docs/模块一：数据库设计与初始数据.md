## 模块一：数据库设计与初始数据

**任务目标**：创建专项训练所需的数据库表，并填充初始内容。

### 1.1 数据库表结构 (Drizzle ORM Schema)

请在你的 Drizzle ORM schema 文件中（例如 `src/db/schema.ts`），添加以下两个表的定义：

```typescript
// src/db/schema.ts

import { pgTable, varchar, text, integer, jsonb } from 'drizzle-orm/pg-core';

// ... (你已有的其他表定义)

// 1. 专项训练表
export const specializedTrainings = pgTable('specialized_trainings', {
  id: varchar('id', { length: 50 }).primaryKey(), // e.g., 'st_accuracy'
  title: varchar('title', { length: 100 }).notNull(), // e.g., '准度射击场'
  description: text('description'),
  iconName: varchar('icon_name', { length: 50 }), // 用于前端显示图标的名称, e.g., 'Target'
  sortOrder: integer('sort_order'), // 排序
});

// 2. 训练计划表
export const trainingPlans = pgTable('training_plans', {
  id: varchar('id', { length: 50 }).primaryKey(), // e.g., 'plan_accuracy_001'
  title: varchar('title', { length: 100 }).notNull(),
  description: text('description'),
  specializedTrainingId: varchar('specialized_training_id', { length: 50 })
    .references(() => specializedTrainings.id),
  difficulty: varchar('difficulty', { length: 20 }).notNull(), // '入门', '进阶', '大师'
  estimatedTime: integer('estimated_time'), // 分钟
  xpReward: integer('xp_reward'),
  steps: jsonb('steps'), // 存储训练步骤的JSON数组
});

```

### 1.2 数据库迁移

保存 schema 文件后，请执行 Drizzle ORM 的迁移命令，将新的表结构应用到你的 PostgreSQL 数据库中。

```bash
pnpm drizzle-kit generate:pg
pnpm drizzle-kit push:pg
```

### 1.3 初始数据填充

创建一个数据填充脚本（例如 `src/db/seed.ts`），用于向新创建的表中插入初始的8个专项训练数据。这可以确保你的开发环境中有可用的数据。

```typescript
// src/db/seed.ts

import { db } from './index';
import { specializedTrainings } from './schema';

async function seed() {
  console.log('Seeding database...');

  const trainings = [
    { id: 'st_basic', title: '基本功道场', description: '站位、手架、出杆的稳定性', iconName: 'Foundation', sortOrder: 1 },
    { id: 'st_power', title: '发力训练营', description: '打点、推接、大力中力小力的控制', iconName: 'Power', sortOrder: 2 },
    { id: 'st_accuracy', title: '准度射击场', description: '瞄准精度、母球贴库、底袋、中袋', iconName: 'Target', sortOrder: 3 },
    { id: 'st_spin', title: '杆法实验室', description: '高中低杆、左中右塞的熟练运用', iconName: 'Spin', sortOrder: 4 },
    { id: 'st_angle', title: '分离角计算器', description: '理解并预判分离角', iconName: 'Angle', sortOrder: 5 },
    { id: 'st_positioning', title: '走位规划室', description: '点线面走位、两库走位', iconName: 'Positioning', sortOrder: 6 },
    { id: 'st_clearance', title: '清台挑战赛', description: '清台能力、连续进球', iconName: 'Clearance', sortOrder: 7 },
    { id: 'st_five_points', title: '五分点速成班', description: '快速掌握五分点技巧', iconName: 'FivePoints', sortOrder: 8 },
  ];

  await db.insert(specializedTrainings).values(trainings).onConflictDoNothing();

  console.log('Database seeded successfully!');
}

seed().catch((error) => {
  console.error('Error seeding database:', error);
  process.exit(1);
});
```

**执行脚本**：
在 `package.json` 中添加一个脚本来运行它，然后执行。

### ✅ 验收标准

- [ ] `specialized_trainings` 和 `training_plans` 两个表已成功创建在数据库中。
- [ ] `specialized_trainings` 表中包含8条初始数据，内容与上述脚本一致。
- [ ] 数据库表结构与 Drizzle ORM schema 定义完全匹配。
## 模块二：后端 API 开发

**任务目标**：创建所需的 API 端点，为前端提供专项训练的数据。

### 2.1 获取所有专项训练列表

**任务**：创建一个 API 端点，返回所有专项训练的列表。

- **文件**：`src/routes/specialized.ts` (如果不存在，请创建)
- **端点**：`GET /api/specialized-trainings`
- **逻辑**：
  1. 从 `specialized_trainings` 表中查询所有记录。
  2. 按 `sortOrder` 字段升序排序。
  3. 返回查询结果。

**代码示例**：

```typescript
// src/routes/specialized.ts
import { Router } from 'express';
import { db } from '../db';
import { specializedTrainings } from '../db/schema';
import { asc } from 'drizzle-orm';

const router = Router();

router.get('/specialized-trainings', async (req, res) => {
  try {
    const trainings = await db.select().from(specializedTrainings).orderBy(asc(specializedTrainings.sortOrder));
    res.json(trainings);
  } catch (error) {
    console.error('Error fetching specialized trainings:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

export default router;
```

**在主应用中挂载路由**：

```typescript
// src/app.ts
// ...
import specializedRoutes from './routes/specialized';

// ...
app.use('/api', specializedRoutes);
// ...
```

### 2.2 获取单个专项下的训练计划（占位符）

**任务**：创建一个占位符 API 端点，用于获取单个专项下的训练计划。由于我们还没有训练计划的数据，这个端点暂时返回一个空数组。

- **文件**：`src/routes/specialized.ts`
- **端点**：`GET /api/specialized-trainings/:trainingId`
- **逻辑**：
  1. 根据 `:trainingId` 从 `specialized_trainings` 表中查询该专项的详细信息。
  2. 暂时返回一个空的 `plans` 数组。

**代码示例**：

```typescript
// src/routes/specialized.ts
// ... (在之前的代码下方添加)
import { eq } from 'drizzle-orm';

router.get('/specialized-trainings/:trainingId', async (req, res) => {
  const { trainingId } = req.params;

  try {
    const training = await db.query.specializedTrainings.findFirst({
      where: eq(specializedTrainings.id, trainingId),
    });

    if (!training) {
      return res.status(404).json({ error: 'Specialized training not found' });
    }

    // TODO: 将来从 training_plans 表中查询相关的训练计划
    const plans = [];

    res.json({
      ...training,
      plans,
    });
  } catch (error) {
    console.error(`Error fetching training ${trainingId}:`, error);
    res.status(500).json({ error: 'Internal server error' });
  }
});
```

### ✅ 验收标准

- [ ] 启动后端服务后，访问 `http://localhost:3001/api/specialized-trainings` (或你的本地端口)，可以成功获取一个包含8个专项训练的JSON数组。
- [ ] 数组中的专项训练已按照 `sortOrder` 排序。
- [ ] 访问 `http://localhost:3001/api/specialized-trainings/st_accuracy`，可以成功获取"准度射击场"的详细信息，并且包含一个空的 `plans` 数组。
- [ ] 访问一个不存在的ID（如 `st_nonexistent`），API 返回 404 错误。
## 模块三：前端页面开发

**任务目标**：在前端应用中展示专项训练模块，并创建相应的页面。

### 3.1 在训练计划主页显示专项训练模块

**任务**：修改训练计划主页（`/tasks`），在“傅家俊十大招”下方，新增“专项训练道场”模块。

- **文件**：`client/src/pages/Tasks.tsx` (或你的训练计划主页文件)
- **逻辑**：
  1. 使用 TanStack Query 的 `useQuery` 调用 `GET /api/specialized-trainings` API。
  2. 获取到数据后，以 2x4 的网格布局渲染8个专项训练的入口卡片。
  3. 每个卡片是一个链接（使用 Wouter 的 `<Link>`），指向该专项的详情页（例如 `/specialized-training/st_accuracy`）。

**代码示例**：

```tsx
// client/src/components/SpecializedTrainingSection.tsx (新建一个组件)
import { useQuery } from '@tanstack/react-query';
import { Link } from 'wouter';

// 假设你有一个获取图标的函数
// import { getIconByName } from '@/lib/icons';

const fetchSpecializedTrainings = async () => {
  const res = await fetch('/api/specialized-trainings');
  if (!res.ok) {
    throw new Error('Network response was not ok');
  }
  return res.json();
};

export function SpecializedTrainingSection() {
  const { data: trainings, isLoading, error } = useQuery({
    queryKey: ['specialized-trainings'],
    queryFn: fetchSpecializedTrainings,
  });

  if (isLoading) return <div>加载中...</div>;
  if (error) return <div>加载失败: {error.message}</div>;

  return (
    <div className="mt-8">
      <h2 className="text-2xl font-bold">专项训练道场</h2>
      <p className="text-muted-foreground">针对性强化你的薄弱环节</p>
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
        {trainings?.map((training) => (
          <Link key={training.id} href={`/specialized-training/${training.id}`}>
            <a className="block p-4 border rounded-lg hover:bg-muted transition-colors">
              {/* {getIconByName(training.iconName)} */}
              <h3 className="font-semibold mt-2">{training.title}</h3>
            </a>
          </Link>
        ))}
      </div>
    </div>
  );
}
```

**在主页面中使用**：

```tsx
// client/src/pages/Tasks.tsx
// ...
import { SpecializedTrainingSection } from '@/components/SpecializedTrainingSection';

export function TasksPage() {
  return (
    <div>
      {/* ... 你已有的每日目标和十大招模块 ... */}
      <SpecializedTrainingSection />
    </div>
  );
}
```

### 3.2 创建专项训练详情页（占位符）

**任务**：创建一个新的页面，用于显示单个专项下的训练计划列表。

- **文件**：`client/src/pages/SpecializedTrainingDetail.tsx` (新建)
- **路由**：在你的主路由文件（例如 `App.tsx`）中添加新路由：
  `<Route path="/specialized-training/:trainingId" component={SpecializedTrainingDetailPage} />`
- **逻辑**：
  1. 从 URL 中获取 `:trainingId`。
  2. 使用 `useQuery` 调用 `GET /api/specialized-trainings/:trainingId` API。
  3. 显示专项的标题和描述。
  4. 显示一个提示信息，告知用户“训练计划即将上线”。

**代码示例**：

```tsx
// client/src/pages/SpecializedTrainingDetail.tsx
import { useQuery } from '@tanstack/react-query';
import { useRoute } from 'wouter';

const fetchTrainingDetail = async (trainingId) => {
  const res = await fetch(`/api/specialized-trainings/${trainingId}`);
  if (!res.ok) {
    throw new Error('Network response was not ok');
  }
  return res.json();
};

export function SpecializedTrainingDetailPage() {
  const [match, params] = useRoute('/specialized-training/:trainingId');
  const trainingId = params?.trainingId;

  const { data: training, isLoading, error } = useQuery({
    queryKey: ['specialized-training', trainingId],
    queryFn: () => fetchTrainingDetail(trainingId),
    enabled: !!trainingId, // 只有当 trainingId 存在时才执行查询
  });

  if (isLoading) return <div>加载中...</div>;
  if (error) return <div>加载失败: {error.message}</div>;

  return (
    <div className="p-4">
      <h1 className="text-3xl font-bold">{training?.title}</h1>
      <p className="text-muted-foreground mt-2">{training?.description}</p>
      
      <div className="mt-8 text-center">
        <p className="text-lg">详细的训练计划即将上线，敬请期待！</p>
      </div>
    </div>
  );
}
```

### ✅ 验收标准

- [ ] 在“训练计划”页面，成功显示了“专项训练道场”模块，包含8个可点击的卡片。
- [ ] 点击“准度射击场”卡片，页面成功跳转到 `/specialized-training/st_accuracy`。
- [ ] 新页面正确显示了“准度射击场”的标题和描述，并显示“训练计划即将上线”的提示。
- [ ] 页面加载时有“加载中”状态，加载失败时有错误提示。
