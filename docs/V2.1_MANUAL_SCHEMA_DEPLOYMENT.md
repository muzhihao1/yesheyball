# V2.1 Schema æ‰‹åŠ¨éƒ¨ç½²æŒ‡å—

**ç”Ÿæˆæ—¶é—´**: 2025-01-10
**çŠ¶æ€**: ğŸŸ¡ éœ€è¦æ‰‹åŠ¨æ‰§è¡ŒSQL

---

## ğŸ“‹ èƒŒæ™¯

ç»è¿‡è°ƒæŸ¥å‘ç°ï¼š
- âœ… ç”Ÿäº§æ•°æ®åº“ (`aws-1-us-east-2.pooler.supabase.com`) å·²ç¡®è®¤
- âœ… SQL migrationæ–‡ä»¶å·²æˆåŠŸç”Ÿæˆ (`migrations/0001_married_onslaught.sql`)
- âŒ è‡ªåŠ¨éƒ¨ç½²å·¥å…·å—é™ï¼ˆæƒé™/åªè¯»æ¨¡å¼é—®é¢˜ï¼‰
- âš ï¸ **éœ€è¦æ‰‹åŠ¨åœ¨Supabase Dashboardæ‰§è¡ŒSQL**

---

## ğŸš€ æ‰§è¡Œæ­¥éª¤

### Step 1: ç™»å½•Supabase Dashboard

1. è®¿é—®ï¼šhttps://supabase.com/dashboard
2. é€‰æ‹©é¡¹ç›®ï¼š`ksgksoeubyvkuwfpdhet` (aws-1-us-east-2)
3. è¿›å…¥ï¼š**SQL Editor**

### Step 2: æ‰§è¡ŒSchema Migration SQL

å¤åˆ¶ä»¥ä¸‹å®Œæ•´SQLåˆ°SQL Editorå¹¶æ‰§è¡Œï¼š

```sql
-- ========================================
-- V2.1 Training System - Complete Schema
-- Generated: 2025-01-10
-- ========================================

-- 1. è®­ç»ƒç­‰çº§è¡¨ (8 levels)
CREATE TABLE IF NOT EXISTS "training_levels" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"level_number" integer NOT NULL,
	"title" varchar(100) NOT NULL,
	"description" text,
	"prerequisite_level_id" uuid,
	"order_index" integer NOT NULL,
	"is_active" boolean DEFAULT true,
	"created_at" timestamp with time zone DEFAULT now() NOT NULL,
	"updated_at" timestamp with time zone DEFAULT now() NOT NULL,
	CONSTRAINT "training_levels_level_number_unique" UNIQUE("level_number")
);

-- 2. è®­ç»ƒæŠ€èƒ½è¡¨ (skills within levels)
CREATE TABLE IF NOT EXISTS "training_skills" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"level_id" uuid NOT NULL,
	"skill_name" varchar(100) NOT NULL,
	"skill_order" integer NOT NULL,
	"description" text,
	"created_at" timestamp with time zone DEFAULT now() NOT NULL,
	"updated_at" timestamp with time zone DEFAULT now() NOT NULL
);

-- 3. å­æŠ€èƒ½è¡¨ (sub-skills within skills)
CREATE TABLE IF NOT EXISTS "sub_skills" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"skill_id" uuid NOT NULL,
	"sub_skill_name" varchar(100) NOT NULL,
	"sub_skill_order" integer NOT NULL,
	"description" text,
	"created_at" timestamp with time zone DEFAULT now() NOT NULL,
	"updated_at" timestamp with time zone DEFAULT now() NOT NULL
);

-- 4. è®­ç»ƒå•å…ƒè¡¨ (training units with JSONB content)
CREATE TABLE IF NOT EXISTS "training_units" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"sub_skill_id" uuid NOT NULL,
	"unit_type" varchar(20) NOT NULL,
	"unit_order" integer NOT NULL,
	"title" varchar(200) NOT NULL,
	"content" jsonb NOT NULL,
	"xp_reward" integer DEFAULT 10,
	"estimated_minutes" integer DEFAULT 5,
	"created_at" timestamp with time zone DEFAULT now() NOT NULL,
	"updated_at" timestamp with time zone DEFAULT now() NOT NULL
);

-- 5. ç”¨æˆ·è®­ç»ƒè¿›åº¦è¡¨
CREATE TABLE IF NOT EXISTS "user_training_progress" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"level_id" uuid NOT NULL,
	"unit_id" uuid NOT NULL,
	"status" varchar(20) DEFAULT 'not_started' NOT NULL,
	"progress_data" jsonb,
	"completed_at" timestamp with time zone,
	"created_at" timestamp with time zone DEFAULT now() NOT NULL,
	"updated_at" timestamp with time zone DEFAULT now() NOT NULL
);

-- 6. ä¸“é¡¹è®­ç»ƒè¡¨
CREATE TABLE IF NOT EXISTS "specialized_trainings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"skill_category" varchar(50) NOT NULL,
	"training_name" varchar(100) NOT NULL,
	"description" text,
	"difficulty_level" integer DEFAULT 1,
	"thumbnail_url" varchar(500),
	"created_at" timestamp with time zone DEFAULT now() NOT NULL,
	"updated_at" timestamp with time zone DEFAULT now() NOT NULL
);

-- 7. ä¸“é¡¹è®­ç»ƒè®¡åˆ’è¡¨
CREATE TABLE IF NOT EXISTS "specialized_training_plans" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"training_id" uuid NOT NULL,
	"plan_order" integer NOT NULL,
	"exercise_name" varchar(200) NOT NULL,
	"exercise_description" text,
	"demo_video_url" varchar(500),
	"target_metrics" jsonb,
	"created_at" timestamp with time zone DEFAULT now() NOT NULL,
	"updated_at" timestamp with time zone DEFAULT now() NOT NULL
);

-- 8. æŠ€èƒ½æ ‘ç›¸å…³è¡¨
CREATE TABLE IF NOT EXISTS "skills" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" varchar(256) NOT NULL,
	"description" text,
	"position" jsonb DEFAULT '{}' NOT NULL,
	"metadata" jsonb DEFAULT '{}' NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);

CREATE TABLE IF NOT EXISTS "skill_dependencies" (
	"source_skill_id" integer NOT NULL,
	"target_skill_id" integer NOT NULL
);

CREATE TABLE IF NOT EXISTS "skill_unlock_conditions" (
	"id" serial PRIMARY KEY NOT NULL,
	"skill_id" integer NOT NULL,
	"condition_type" varchar(50) NOT NULL,
	"condition_value" text NOT NULL,
	"required_count" integer DEFAULT 1 NOT NULL,
	"condition_description" text,
	"created_at" timestamp DEFAULT now() NOT NULL
);

CREATE TABLE IF NOT EXISTS "user_skill_progress" (
	"user_id" varchar NOT NULL,
	"skill_id" integer NOT NULL,
	"unlocked_at" timestamp DEFAULT now() NOT NULL,
	"unlock_context" jsonb DEFAULT '{}' NOT NULL
);

-- 9. ç›®æ ‡ç³»ç»Ÿè¡¨
CREATE TABLE IF NOT EXISTS "goal_templates" (
	"id" serial PRIMARY KEY NOT NULL,
	"type" text NOT NULL,
	"description" text NOT NULL,
	"difficulty" text DEFAULT 'EASY' NOT NULL,
	"reward_xp" integer DEFAULT 10 NOT NULL,
	"active" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);

CREATE TABLE IF NOT EXISTS "user_daily_goals" (
	"id" serial PRIMARY KEY NOT NULL,
	"user_id" varchar NOT NULL,
	"goal_template_id" integer NOT NULL,
	"date" timestamp NOT NULL,
	"target_value" integer NOT NULL,
	"current_value" integer DEFAULT 0 NOT NULL,
	"is_completed" boolean DEFAULT false NOT NULL,
	"completed_at" timestamp,
	"created_at" timestamp DEFAULT now() NOT NULL
);

-- 10. æ›´æ–°usersè¡¨ (æ·»åŠ æ–°å­—æ®µ)
ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "password_hash" text;
ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "supabase_user_id" uuid;
ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "migrated_to_supabase" boolean DEFAULT false NOT NULL;
ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "current_day" integer DEFAULT 1 NOT NULL;

-- ========================================
-- å¤–é”®çº¦æŸ (Foreign Keys)
-- ========================================

-- Training hierarchy constraints
ALTER TABLE "training_skills"
  DROP CONSTRAINT IF EXISTS "training_skills_level_id_training_levels_id_fk";
ALTER TABLE "training_skills"
  ADD CONSTRAINT "training_skills_level_id_training_levels_id_fk"
  FOREIGN KEY ("level_id") REFERENCES "public"."training_levels"("id")
  ON DELETE cascade ON UPDATE no action;

ALTER TABLE "sub_skills"
  DROP CONSTRAINT IF EXISTS "sub_skills_skill_id_training_skills_id_fk";
ALTER TABLE "sub_skills"
  ADD CONSTRAINT "sub_skills_skill_id_training_skills_id_fk"
  FOREIGN KEY ("skill_id") REFERENCES "public"."training_skills"("id")
  ON DELETE cascade ON UPDATE no action;

ALTER TABLE "training_units"
  DROP CONSTRAINT IF EXISTS "training_units_sub_skill_id_sub_skills_id_fk";
ALTER TABLE "training_units"
  ADD CONSTRAINT "training_units_sub_skill_id_sub_skills_id_fk"
  FOREIGN KEY ("sub_skill_id") REFERENCES "public"."sub_skills"("id")
  ON DELETE cascade ON UPDATE no action;

-- Training levels self-reference
ALTER TABLE "training_levels"
  DROP CONSTRAINT IF EXISTS "training_levels_prerequisite_level_id_training_levels_id_fk";
ALTER TABLE "training_levels"
  ADD CONSTRAINT "training_levels_prerequisite_level_id_training_levels_id_fk"
  FOREIGN KEY ("prerequisite_level_id") REFERENCES "public"."training_levels"("id")
  ON DELETE no action ON UPDATE no action;

-- User progress constraints
ALTER TABLE "user_training_progress"
  DROP CONSTRAINT IF EXISTS "user_training_progress_user_id_users_id_fk";
ALTER TABLE "user_training_progress"
  ADD CONSTRAINT "user_training_progress_user_id_users_id_fk"
  FOREIGN KEY ("user_id") REFERENCES "public"."users"("id")
  ON DELETE cascade ON UPDATE no action;

ALTER TABLE "user_training_progress"
  DROP CONSTRAINT IF EXISTS "user_training_progress_level_id_training_levels_id_fk";
ALTER TABLE "user_training_progress"
  ADD CONSTRAINT "user_training_progress_level_id_training_levels_id_fk"
  FOREIGN KEY ("level_id") REFERENCES "public"."training_levels"("id")
  ON DELETE cascade ON UPDATE no action;

ALTER TABLE "user_training_progress"
  DROP CONSTRAINT IF EXISTS "user_training_progress_unit_id_training_units_id_fk";
ALTER TABLE "user_training_progress"
  ADD CONSTRAINT "user_training_progress_unit_id_training_units_id_fk"
  FOREIGN KEY ("unit_id") REFERENCES "public"."training_units"("id")
  ON DELETE cascade ON UPDATE no action;

-- Specialized training constraints
ALTER TABLE "specialized_training_plans"
  DROP CONSTRAINT IF EXISTS "specialized_training_plans_training_id_specialized_trainings_id_fk";
ALTER TABLE "specialized_training_plans"
  ADD CONSTRAINT "specialized_training_plans_training_id_specialized_trainings_id_fk"
  FOREIGN KEY ("training_id") REFERENCES "public"."specialized_trainings"("id")
  ON DELETE cascade ON UPDATE no action;

-- Skill tree constraints
ALTER TABLE "skill_dependencies"
  DROP CONSTRAINT IF EXISTS "skill_dependencies_source_skill_id_skills_id_fk";
ALTER TABLE "skill_dependencies"
  ADD CONSTRAINT "skill_dependencies_source_skill_id_skills_id_fk"
  FOREIGN KEY ("source_skill_id") REFERENCES "public"."skills"("id")
  ON DELETE cascade ON UPDATE no action;

ALTER TABLE "skill_dependencies"
  DROP CONSTRAINT IF EXISTS "skill_dependencies_target_skill_id_skills_id_fk";
ALTER TABLE "skill_dependencies"
  ADD CONSTRAINT "skill_dependencies_target_skill_id_skills_id_fk"
  FOREIGN KEY ("target_skill_id") REFERENCES "public"."skills"("id")
  ON DELETE cascade ON UPDATE no action;

ALTER TABLE "skill_unlock_conditions"
  DROP CONSTRAINT IF EXISTS "skill_unlock_conditions_skill_id_skills_id_fk";
ALTER TABLE "skill_unlock_conditions"
  ADD CONSTRAINT "skill_unlock_conditions_skill_id_skills_id_fk"
  FOREIGN KEY ("skill_id") REFERENCES "public"."skills"("id")
  ON DELETE cascade ON UPDATE no action;

ALTER TABLE "user_skill_progress"
  DROP CONSTRAINT IF EXISTS "user_skill_progress_user_id_users_id_fk";
ALTER TABLE "user_skill_progress"
  ADD CONSTRAINT "user_skill_progress_user_id_users_id_fk"
  FOREIGN KEY ("user_id") REFERENCES "public"."users"("id")
  ON DELETE cascade ON UPDATE no action;

ALTER TABLE "user_skill_progress"
  DROP CONSTRAINT IF EXISTS "user_skill_progress_skill_id_skills_id_fk";
ALTER TABLE "user_skill_progress"
  ADD CONSTRAINT "user_skill_progress_skill_id_skills_id_fk"
  FOREIGN KEY ("skill_id") REFERENCES "public"."skills"("id")
  ON DELETE cascade ON UPDATE no action;

-- Goal system constraints
ALTER TABLE "user_daily_goals"
  DROP CONSTRAINT IF EXISTS "user_daily_goals_user_id_users_id_fk";
ALTER TABLE "user_daily_goals"
  ADD CONSTRAINT "user_daily_goals_user_id_users_id_fk"
  FOREIGN KEY ("user_id") REFERENCES "public"."users"("id")
  ON DELETE no action ON UPDATE no action;

ALTER TABLE "user_daily_goals"
  DROP CONSTRAINT IF EXISTS "user_daily_goals_goal_template_id_goal_templates_id_fk";
ALTER TABLE "user_daily_goals"
  ADD CONSTRAINT "user_daily_goals_goal_template_id_goal_templates_id_fk"
  FOREIGN KEY ("goal_template_id") REFERENCES "public"."goal_templates"("id")
  ON DELETE no action ON UPDATE no action;

-- ========================================
-- ç´¢å¼• (Indexes)
-- ========================================

CREATE UNIQUE INDEX IF NOT EXISTS "user_training_progress_user_unit_unique"
  ON "user_training_progress" USING btree ("user_id","unit_id");

-- ========================================
-- å®Œæˆï¼
-- ========================================
```

### Step 3: éªŒè¯è¡¨åˆ›å»ºæˆåŠŸ

æ‰§è¡Œä»¥ä¸‹SQLæŸ¥è¯¢éªŒè¯ï¼š

```sql
-- æ£€æŸ¥V2.1æ ¸å¿ƒè¡¨
SELECT table_name,
       (SELECT COUNT(*) FROM information_schema.columns
        WHERE columns.table_name = tables.table_name
        AND columns.table_schema = 'public') as column_count
FROM information_schema.tables tables
WHERE table_schema = 'public'
  AND table_name IN (
    'training_levels', 'training_skills', 'sub_skills',
    'training_units', 'user_training_progress'
  )
ORDER BY table_name;
```

**é¢„æœŸç»“æœ**: åº”è¯¥è¿”å›5è¡Œï¼Œæ¯ä¸ªè¡¨éƒ½æœ‰å¯¹åº”çš„åˆ—æ•°

---

## âœ… æ‰§è¡ŒæˆåŠŸæ ‡å¿—

- [  ] SQLæ‰§è¡Œæ— é”™è¯¯
- [  ] éªŒè¯æŸ¥è¯¢è¿”å›5ä¸ªè¡¨
- [  ] `training_levels` æœ‰9åˆ—
- [  ] `training_skills` æœ‰7åˆ—
- [  ] `sub_skills` æœ‰7åˆ—
- [  ] `training_units` æœ‰10åˆ—
- [  ] `user_training_progress` æœ‰9åˆ—

---

## ğŸ”„ ä¸‹ä¸€æ­¥

Schemaéƒ¨ç½²æˆåŠŸåï¼Œç»§ç»­æ‰§è¡Œï¼š

1. **å¯¼å…¥V2.1è®­ç»ƒæ•°æ®**:
   ```bash
   npx tsx scripts/import-training-data.ts
   ```

2. **éªŒè¯APIç«¯ç‚¹**:
   ```bash
   curl https://yesheyball.vercel.app/api/training/levels
   ```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `migrations/0001_married_onslaught.sql` - å®Œæ•´çš„ç”ŸæˆSQLæ–‡ä»¶
- `scripts/import-training-data.ts` - æ•°æ®å¯¼å…¥è„šæœ¬
- `docs/V2.1_DEPLOYMENT_STATUS.md` - éƒ¨ç½²çŠ¶æ€æ€»è§ˆ

---

**åˆ›å»ºæ—¶é—´**: 2025-01-10
**çŠ¶æ€**: ğŸŸ¡ ç­‰å¾…æ‰‹åŠ¨æ‰§è¡Œ
