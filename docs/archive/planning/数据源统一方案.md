# 数据源统一方案

## 审阅日期
2025-11-17

## 审阅目标
识别并修复网站中数据不一致的根源，制定统一数据架构方案。

---

## 一、数据不一致问题汇总

### 问题 1：能力评分数据不一致（P0 - 严重）

**症状**：
- Profile 页面显示：准度 67
- 其他页面显示：准度 100
- 类似问题存在于所有 5 个维度的能力评分

**根本原因**：

#### 1.1 多个 API 端点返回相同数据
```typescript
// 端点 1: /api/v1/dashboard/summary (useDashboardSummary)
// 文件：server/routes.ts:3085-3092
abilityScores: {
  accuracy: user.accuracyScore || 0,      // camelCase
  spin: user.spinScore || 0,
  positioning: user.positioningScore || 0,
  power: user.powerScore || 0,
  strategy: user.strategyScore || 0,
  clearance: user.clearanceScore || 0
}

// 端点 2: /api/users/:id/ability-scores (useAbilityScores)
// 文件：server/routes.ts:2850
// 调用 getUserAbilityScores() → server/abilityScoreEngine.ts:403
// 返回 snake_case 字段：
{
  accuracy_score: Number(row.accuracy_score) || 0,  // snake_case
  spin_score: Number(row.spin_score) || 0,
  // ...
}

// 端点 3: /api/users/:id/ninety-day-progress (useAbilityScoresForProfile)
// 文件：server/routes.ts:2982-2987
// 返回 snake_case 字段：
{
  accuracy_score: user?.accuracyScore || 0,  // 数据库是 camelCase，API 返回 snake_case
  spin_score: user?.spinScore || 0,
  // ...
}
```

#### 1.2 前端多个 Hook 获取相同数据
```typescript
// Hook 1: useDashboardSummary()
// 文件：client/src/hooks/useDashboardSummary.ts:36
// 查询：/api/v1/dashboard/summary
// 返回：abilityScores { accuracy, spin, positioning, power, strategy, clearance }

// Hook 2: useAbilityScoresForProfile()
// 文件：client/src/hooks/useAbilityScoresForProfile.ts
// 查询：/api/users/${userId}/ninety-day-progress
// 返回：AbilityScores { accuracy_score, spin_score, ... }

// Hook 3: useAbilityScores()
// 文件：client/src/hooks/useNinetyDayTraining.ts:430
// 查询：/api/users/${userId}/ability-scores
// 返回：AbilityScores { accuracy_score, spin_score, ... }
```

#### 1.3 Profile 页面使用多数据源 + Fallback 逻辑
```typescript
// 文件：client/src/pages/profile.tsx:36-49

// 同时获取两个数据源
const { data: dashboardData } = useDashboardSummary();
const { data: abilityScores } = useAbilityScoresForProfile(user?.id);

// 转换 dashboard 数据格式
const transformedAbilityScores = dashboardData?.abilityScores ? {
  accuracy_score: dashboardData.abilityScores.accuracy,  // camelCase → snake_case
  spin_score: dashboardData.abilityScores.spin,
  // ...
} : undefined;

// 使用 fallback 逻辑 - 哪个先加载用哪个！
<AbilityRadarChart scores={transformedAbilityScores || abilityScores} />
<AbilityScoreBars scores={transformedAbilityScores || abilityScores} />
```

**问题**：
- 两个 Hook 可能在不同时间返回数据（race condition）
- 先加载的数据会被显示，导致不一致
- 数据格式转换增加复杂度和出错机会

#### 1.4 数据库字段命名
```typescript
// 文件：shared/schema.ts:46-51
// Drizzle ORM 定义：
accuracyScore: integer("accuracy_score").notNull().default(0),
spinScore: integer("spin_score").notNull().default(0),
// ...

// TypeScript 字段名：accuracyScore (camelCase)
// 数据库列名：accuracy_score (snake_case)
// 使用 Drizzle ORM 查询：user.accuracyScore
// 使用原始 SQL 查询：row.accuracy_score
```

---

### 问题 2：连续天数数据不一致（P0 - 严重）

**症状**：
- 某些页面显示：连续 0 天
- 其他页面显示：连续 2 天

**根本原因**：

#### 2.1 两个独立的训练系统
```typescript
// 系统 1: 技能库系统（旧）
// 训练记录表：training_sessions
// API：/api/user/streak → calculateTrainingStreak(completedSessions)
// 文件：server/routes.ts:233, 63

function calculateTrainingStreak(completedSessions: any[]) {
  // 基于 getUserTrainingSessions(userId) 的数据
  // 来源：training_sessions 表
}

// 系统 2: 90天挑战系统（新）
// 训练记录表：ninety_day_training_records
// 该系统的训练记录 NOT 计入 streak 计算！
```

**问题**：
- 用户在 90天挑战中完成训练 → 记录保存到 `ninety_day_training_records`
- Profile 页面显示 streak → 从 `training_sessions` 查询
- 结果：90天挑战的训练不计入连续天数！

---

### 问题 3：技能库进度数据不一致（P1 - 高优先级）

**症状**：
- Dashboard 显示：0 个技能进行中
- 技能库页面显示：2 个技能进行中

**根本原因**：

#### 3.1 数据源一致，但缓存不同步
```typescript
// 两个端点查询同一张表
// 端点 1: /api/v1/dashboard/summary
// 文件：server/routes.ts:3060-3073
const skillsProgress = await db!
  .select()
  .from(userSkillProgressV3)
  .where(eq(userSkillProgressV3.userId, targetUserId));

// 端点 2: /api/user/skills-v3/progress
// 文件：server/routes.ts:2583
const progress = await storage.getUserSkillProgressV3(userId, skillId?);
```

**问题**：
- React Query 为两个端点维护独立的缓存
- `useDashboardSummary()` queryKey: `["/api/v1/dashboard/summary"]`
- `useUserSkillProgressV3()` queryKey: `['skills-v3', 'progress', userId]`
- 数据更新后，只有一个缓存被刷新，另一个仍显示旧数据

---

## 二、统一数据源方案

### 核心原则

1. **单一数据源（Single Source of Truth）**
   - 每种数据只有一个权威 API 端点
   - 所有组件使用同一个 React Hook
   - 统一字段命名规范

2. **统一缓存管理**
   - 相关数据使用相同的 queryKey 前缀
   - 数据更新时自动刷新所有相关缓存

3. **训练系统统一**
   - 合并两个训练系统的数据
   - 统一训练记录存储

---

### 方案 A：推荐方案 - 完全统一架构

#### A.1 能力评分统一

**实施步骤**：

1. **废弃多余的 API 端点**
```typescript
// 保留：/api/v1/dashboard/summary（唯一权威数据源）
// 废弃：/api/users/:id/ability-scores
// 废弃：/api/users/:id/ninety-day-progress（或重构为专门返回挑战进度）
```

2. **统一前端 Hook**
```typescript
// 创建新的统一 Hook：useAbilityScores()
// 文件：client/src/hooks/useAbilityScores.ts

export interface AbilityScores {
  accuracy: number;
  spin: number;
  positioning: number;
  power: number;
  strategy: number;
  clearance: number;
}

export function useAbilityScores() {
  return useQuery<AbilityScores>({
    queryKey: ['/api/ability-scores'],  // 统一 key
    queryFn: async () => {
      const response = await fetch('/api/v1/dashboard/summary', {
        headers: getAuthHeaders(),
        credentials: 'include',
      });
      if (!response.ok) throw new Error('Failed to fetch ability scores');
      const data = await response.json();
      return data.abilityScores;  // 直接返回，无需转换
    },
    staleTime: 2 * 60 * 1000,
  });
}
```

3. **统一字段命名 - 使用 camelCase**
```typescript
// 数据库 schema 保持不变（已经是 camelCase TypeScript 字段）
// API 返回统一使用 camelCase
// 前端类型定义统一使用 camelCase
// 废弃所有 snake_case 的 API 返回
```

4. **更新所有使用的组件**
```typescript
// client/src/pages/profile.tsx
import { useAbilityScores } from '@/hooks/useAbilityScores';

// 只使用一个数据源
const { data: abilityScores, isLoading } = useAbilityScores();

// 直接传递，无需转换
<AbilityRadarChart scores={abilityScores} isLoading={isLoading} />
<AbilityScoreBars scores={abilityScores} isLoading={isLoading} />
```

5. **更新组件类型导入**
```typescript
// client/src/components/ninety-day/AbilityRadarChart.tsx
// 修改 line 4
import type { AbilityScores } from '@/hooks/useAbilityScores';

// client/src/components/AbilityScoreBars.tsx
// 修改 line 3
import type { AbilityScores } from '@/hooks/useAbilityScores';
```

#### A.2 训练系统统一

**实施步骤**：

1. **创建统一训练记录视图**
```sql
-- 创建数据库视图合并两个训练记录表
CREATE VIEW unified_training_records AS
SELECT
  id,
  user_id,
  created_at as completed_at,
  'skills_library' as source_system
FROM training_sessions
WHERE completed = true

UNION ALL

SELECT
  id::text as id,
  user_id,
  completed_at,
  'ninety_day_challenge' as source_system
FROM ninety_day_training_records;
```

2. **更新 Streak 计算逻辑**
```typescript
// server/routes.ts
app.get("/api/user/streak", isAuthenticated, async (req, res) => {
  const userId = requireSessionUserId(req);

  // 获取所有训练记录（包括两个系统）
  const skillsLibrarySessions = await storage.getUserTrainingSessions(userId);
  const ninetyDaySessions = await storage.getUserNinetyDayTrainingRecords(userId);

  // 合并并转换为统一格式
  const allSessions = [
    ...skillsLibrarySessions.filter(s => s.completed).map(s => ({
      completedAt: s.createdAt,
      source: 'skills_library'
    })),
    ...ninetyDaySessions.map(s => ({
      completedAt: s.completedAt,
      source: 'ninety_day_challenge'
    }))
  ];

  // 计算 streak
  const streakData = calculateTrainingStreak(allSessions);
  res.json(streakData);
});
```

3. **缓存统一管理**
```typescript
// 当用户完成训练时，刷新所有相关缓存
const queryClient = useQueryClient();

// 训练完成后
queryClient.invalidateQueries({ queryKey: ['/api/user/streak'] });
queryClient.invalidateQueries({ queryKey: ['/api/v1/dashboard/summary'] });
queryClient.invalidateQueries({ queryKey: ['/api/ability-scores'] });
```

#### A.3 技能库进度统一

**实施步骤**：

1. **使用 Dashboard Summary 作为唯一数据源**
```typescript
// 修改 client/src/hooks/useDashboardSummary.ts
// 添加专门的 Hook 用于技能库进度

export function useSkillsLibraryProgress() {
  const { data, ...rest } = useDashboardSummary();

  return {
    data: data?.skillsLibrary,
    ...rest
  };
}
```

2. **更新所有使用技能库进度的组件**
```typescript
// 替换所有 useUserSkillProgressV3() 为：
import { useSkillsLibraryProgress } from '@/hooks/useDashboardSummary';

const { data: skillsProgress } = useSkillsLibraryProgress();
```

3. **保留详细查询端点用于特定场景**
```typescript
// /api/user/skills-v3/progress 仅用于：
// - 单个技能的详细进度查询
// - 技能详情页面
// 不用于 Dashboard 或 Profile 页面
```

---

### 方案 B：渐进式改进（低风险）

如果不想大规模重构，可以采用渐进式改进：

#### B.1 第一阶段：修复 Profile 页面（1-2小时）

```typescript
// client/src/pages/profile.tsx

// 只使用一个数据源
const { data: dashboardData, isLoading } = useDashboardSummary();
// 移除 useAbilityScoresForProfile()

// 统一数据格式转换
const abilityScores = dashboardData?.abilityScores ? {
  accuracy_score: dashboardData.abilityScores.accuracy,
  spin_score: dashboardData.abilityScores.spin,
  positioning_score: dashboardData.abilityScores.positioning,
  power_score: dashboardData.abilityScores.power,
  strategy_score: dashboardData.abilityScores.strategy,
  clearance_score: dashboardData.abilityScores.clearance,
} : null;

// 统一传递
<AbilityRadarChart scores={abilityScores} isLoading={isLoading} />
<AbilityScoreBars scores={abilityScores} isLoading={isLoading} />
```

#### B.2 第二阶段：统一 Streak 计算（2-3小时）
- 合并两个训练系统的记录
- 更新 `/api/user/streak` 端点
- 测试 streak 计算准确性

#### B.3 第三阶段：文档化和清理（1小时）
- 标记废弃的 API 端点
- 添加注释说明数据源
- 更新 CLAUDE.md 文档

---

## 三、实施计划

### 优先级排序

**P0 - 立即修复（今天）**：
1. Profile 页面能力评分显示不一致
2. 连续天数计算错误（90天挑战训练未计入）

**P1 - 本周内完成**：
1. 技能库进度缓存同步
2. API 端点统一和清理

**P2 - 下周完成**：
1. 完整的数据架构重构
2. 单元测试覆盖

### 推荐实施路线

**选择方案 A（完全统一）**的原因：
1. 从根本上解决问题，避免未来反复修复
2. 代码更清晰，易于维护
3. 降低未来开发的心智负担
4. 总工作量：约 8-10 小时

**实施步骤**：
1. 创建新的统一 Hook (2小时)
2. 更新 Profile 页面 (1小时)
3. 更新其他使用能力评分的页面 (2小时)
4. 统一训练系统 Streak 计算 (2小时)
5. 测试和修复 Bug (2小时)
6. 清理废弃代码和文档 (1小时)

---

## 四、验证标准

实施完成后，需验证：

### 4.1 数据一致性验证
- [ ] Profile 页面能力评分与 Dashboard 一致
- [ ] 雷达图和能力条显示相同数值
- [ ] 刷新页面后数值不变

### 4.2 连续天数验证
- [ ] 完成 90天挑战训练后，连续天数 +1
- [ ] 完成技能库训练后，连续天数 +1
- [ ] 两个系统的训练都计入总天数

### 4.3 技能库进度验证
- [ ] Dashboard 和技能库页面显示相同进度
- [ ] 完成训练单元后，两处同步更新
- [ ] 缓存刷新机制正常工作

### 4.4 性能验证
- [ ] 页面加载时间未增加
- [ ] API 调用次数未增加（应该减少）
- [ ] React Query devtools 显示缓存正确命中

---

## 五、风险评估

| 风险 | 等级 | 缓解措施 |
|------|------|---------|
| 破坏现有功能 | 中 | 渐进式实施，每步充分测试 |
| 数据库迁移失败 | 低 | 使用视图而非修改表结构 |
| 缓存问题 | 中 | 实施前清空所有缓存，测试冷启动 |
| 用户数据丢失 | 极低 | 只修改查询逻辑，不删除数据 |

---

## 六、后续优化建议

1. **添加数据一致性监控**
   - 定期检查多个端点返回的数据是否一致
   - 发现不一致时记录日志并告警

2. **统一类型定义**
   - 将所有共享类型移到 `shared/types.ts`
   - 前后端导入同一类型定义

3. **API 版本化**
   - 新 API 使用 `/api/v2/`
   - 明确标注 deprecated endpoints

4. **单元测试**
   - 为关键计算函数添加单元测试
   - 测试边界情况（0天、90天、跨年等）
