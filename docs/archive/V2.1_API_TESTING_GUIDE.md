# V2.1 API测试与数据导入完整指南

**创建时间**: 2025-11-10
**目标读者**: 产品负责人、内容团队
**预计完成时间**: 1-2小时

---

## 📋 执行摘要

V2.1 Training System的后端基础设施已100%完成：
- ✅ 数据库Schema（7个表）已推送到Supabase
- ✅ Storage数据访问层（9个方法）已实现
- ✅ API路由层（8个端点）已实现
- ✅ TypeScript类型系统完整

**现在需要**：
1. 测试API端点确保正常工作
2. 提供"十大招"训练内容数据
3. 运行数据导入脚本

---

## 🚀 快速开始：API测试

### 步骤1：启动开发服务器

```bash
# 终端执行
npm run dev
```

**期望输出**：
```
Connected to database successfully
Server running on http://localhost:5000
```

**故障排查**：
- 如果端口被占用：`lsof -ti:5000 | xargs kill -9`
- 如果数据库连接失败：检查`.env`文件中的`DATABASE_URL`

### 步骤2：运行API测试脚本

```bash
# 新终端窗口执行
npx tsx scripts/test-training-api.ts
```

**期望输出**：
```
🧪 V2.1 Training API 测试开始

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📖 测试 Read Endpoints (GET)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Test 1: 获取所有训练关卡
✅ 成功！找到 0 个关卡
⚠️  数据库为空，需要导入数据

...

📊 测试结果汇总
总计: 4 个测试
✅ 通过: 4
❌ 失败: 0
成功率: 100%
```

**解释**：
- 如果测试全部通过但返回"0个关卡"，说明API工作正常，**只是数据库为空**
- 如果测试失败，检查错误信息并修复

---

## 📝 内容准备：你需要提供什么

### 重要决策：选择数据映射方案

请阅读 `docs/DATA_MAPPING_ANALYSIS.md` 并选择：

**方案A（推荐）**：8个成长等级 + 10个招式
- Level 1 = 新手起步（包含"第一招：基本功"）
- Level 2 = 力量觉醒（包含"第二招：发力"）
- ...

**方案B**：修改Schema（不推荐，需要重构）

**👉 请确认使用方案A**

---

### 必需的内容数据（优先级P0 - 前三招）

#### 📌 第一招：基本功（2章节，10关卡）

**章节一：稳固的根基**（5个关卡）

| 关卡# | 类型 | 标题 | 需要的内容 |
|------|------|------|-----------|
| 1.1.1 | Theory | 万丈高楼平地起：认识四大动作 | ✅ 已有示例，可以补充 |
| 1.1.2 | Practice | 手架：稳如泰山 | ✅ 已有示例，可以补充 |
| 1.1.3 | Practice | 握杆：松紧有度 | ❌ 需要提供 |
| 1.1.4 | Practice | 入位：瞄准视角 | ❌ 需要提供 |
| 1.1.5 | Challenge | 基本功综合测试 | ❌ 需要提供（成功标准） |

**章节二：笔直的出杆**（5个关卡）

| 关卡# | 类型 | 标题 | 需要的内容 |
|------|------|------|-----------|
| 1.2.1 | Theory | 笔直出杆的重要性 | ❌ 需要提供 |
| 1.2.2 | Practice | 慢速出杆练习 | ❌ 需要提供 |
| 1.2.3 | Practice | 击打白球定杆 | ❌ 需要提供 |
| 1.2.4 | Practice | 瓶子练习法 | ❌ 需要提供 |
| 1.2.5 | Challenge | 出杆稳定性测试 | ❌ 需要提供 |

#### 📌 第二招：发力（4个关卡）

| 关卡# | 类型 | 标题 | 需要的内容 |
|------|------|------|-----------|
| 2.1 | Theory | 发力原理 | ❌ 需要提供 |
| 2.2 | Practice | 小臂发力练习 | ❌ 需要提供 |
| 2.3 | Practice | 力量渐进训练 | ❌ 需要提供 |
| 2.4 | Challenge | 发力准确性测试 | ❌ 需要提供 |

#### 📌 第三招：高效五分点（3个关卡）

| 关卡# | 类型 | 标题 | 需要的内容 |
|------|------|------|-----------|
| 3.1 | Theory | 五分点系统解析 | ❌ 需要提供 |
| 3.2 | Practice | 五分点基础练习 | ❌ 需要提供 |
| 3.3 | Challenge | 定杆马拉松挑战 | ❌ 需要提供（目标：连续20颗） |

---

### 内容格式要求

#### 理论关卡 (Theory)

```markdown
# 关卡标题

## 核心概念
（用2-3段话解释核心原理）

## 为什么重要？
- ✅ 原因1
- ✅ 原因2
- ✅ 原因3

## 关键要点
1. 要点1的详细解释...
2. 要点2的详细解释...

## 避免的常见错误
- ❌ 错误1
- ❌ 错误2

**视频链接**：[可选] https://...
**图片参考**：[可选] 图片描述或URL
```

#### 练习关卡 (Practice)

```markdown
# 关卡标题

## 标准动作/练习步骤：
1. 步骤1的详细描述...
2. 步骤2的详细描述...
3. ...

## 练习目标：
- 完成 **X次** 标准动作
- 每次保持 **Y秒/分钟**
- 成功率达到 **Z%**

## 自我检查：
- [ ] 检查点1
- [ ] 检查点2
- [ ] 检查点3

## 示范视频：[必需]
URL或描述

## 常见问题与解决方法：
**问题1**：描述
**解决**：方法

**XP奖励**：20 XP
**建议时长**：15-20分钟
```

#### 挑战关卡 (Challenge)

```markdown
# 关卡标题

## 挑战说明：
（描述挑战的具体内容）

## 成功标准：
- 标准1（必须达成）
- 标准2（必须达成）
- **通过条件**: 成功率 ≥ X% 或 连续成功 Y 次

## 失败后怎么办：
- 建议复习的关卡
- 需要加强练习的技能点

**XP奖励**：30 XP
**时间限制**：无限制（可重复挑战）
```

---

## 📥 数据导入流程

### 步骤1：填充内容到导入脚本

编辑文件：`scripts/import-training-data.ts`

找到 `TEN_SKILLS_DATA` 数组，按照现有示例格式添加内容：

```typescript
{
  levelNumber: 1,
  skillName: "基本功",
  skillOrder: 1,
  description: "...",
  subSkills: [
    {
      subSkillName: "稳固的根基",
      subSkillOrder: 1,
      description: "...",
      units: [
        {
          unitType: "theory",
          unitOrder: 1,
          title: "万丈高楼平地起：认识四大动作",
          content: {
            type: "theory",
            text: `你提供的Markdown内容`,
            images: ["图片URL1", "图片URL2"],
            video: "视频URL"
          },
          xpReward: 10,
          estimatedMinutes: 5
        },
        // ... 更多关卡
      ]
    }
  ]
}
```

### 步骤2：运行导入脚本

```bash
npx tsx scripts/import-training-data.ts
```

**期望输出**：
```
🚀 开始导入V2.1训练数据...

📊 Step 1/5: 导入8个训练等级...
   ✅ Level 1: 新手起步
   ✅ Level 2: 力量觉醒
   ...

🎯 Step 2/5: 导入十大招技能...
   ✅ 基本功 (Level 1)
   ✅ 发力 (Level 2)
   ...

📖 Step 3/5: 导入子技能（章节）...
   ✅ 稳固的根基 (基本功)
   ✅ 笔直的出杆 (基本功)
   ...

🎮 Step 4/5: 导入训练单元（关卡）...
   ✅ [theory] 万丈高楼平地起：认识四大动作
   ✅ [practice] 手架：稳如泰山
   ...

💪 Step 5/5: 导入专项训练...
   ✅ 基本功强化

🎉 数据导入完成！

📊 导入统计：
   - 训练等级: 8
   - 技能(十大招): 10
   - 子技能(章节): 15
   - 训练单元(关卡): 42
   - 专项训练: 8
```

### 步骤3：验证导入成功

再次运行API测试：

```bash
npx tsx scripts/test-training-api.ts
```

**期望输出**：
```
Test 1: 获取所有训练关卡
✅ 成功！找到 8 个关卡
   示例: Level 1 - 新手起步

Test 2: 获取关卡详情（需要先有数据）
✅ 成功！获取到Level 1 的详细信息
   技能数量: 1

...

📊 测试结果汇总
✅ 通过: 4
成功率: 100%
```

### 步骤4：浏览器手动测试（可选）

启动服务器后，在浏览器访问：

```
# 获取所有关卡
http://localhost:5000/api/training/levels

# 获取关卡详情（替换{levelId}为实际ID）
http://localhost:5000/api/training/levels/{levelId}

# 获取专项训练
http://localhost:5000/api/specialized-trainings
```

---

## 🎯 完成后的下一步

### Sprint 1 收尾（预计2小时）
- [ ] 编写单元测试（可选，但推荐）
- [ ] 更新`V2.1_PROGRESS_REPORT.md`为100%
- [ ] 准备Sprint 2启动会

### Sprint 2 启动（预计开始时间：2025-11-18）
- [ ] 前端页面开发：
  - `training.tsx` - 训练计划主页改版
  - `levels.tsx` - 关卡地图页面增强
  - 新页面：专项训练列表、训练单元详情
- [ ] Custom React Hooks：
  - `useTrainingLevels()`
  - `useTrainingLevel(levelId)`
  - `useTrainingUnit(unitId)`
  - `useTrainingProgress()`

---

## 📞 支持与资源

### 相关文档
- **数据映射分析**: `docs/DATA_MAPPING_ANALYSIS.md`
- **API实现报告**: `docs/V2.1_API_IMPLEMENTATION_COMPLETE.md`
- **数据库推送成功报告**: `docs/DATABASE_PUSH_SUCCESS.md`
- **开发方案**: `docs/DEVELOPMENT_PLAN_V2.1.md`

### 脚本位置
- 数据导入: `scripts/import-training-data.ts`
- API测试: `scripts/test-training-api.ts`

### 如果遇到问题

**数据库连接失败**：
```bash
# 检查.env文件
cat .env | grep DATABASE_URL

# 应该看到Session Pooler连接字符串
DATABASE_URL="postgresql://postgres.ksgksoeubyvkuwfpdhet:..."
```

**导入脚本报错**：
- 检查TypeScript编译：`npm run check`
- 检查数据格式是否符合Schema定义
- 查看错误消息中的具体字段名

**API测试失败**：
- 确认服务器正在运行（`npm run dev`）
- 检查端口5000是否被占用
- 查看服务器控制台的错误日志

---

**文档更新**: 2025-11-10
**预计完成时间**: 提供内容后30分钟内可完成导入
