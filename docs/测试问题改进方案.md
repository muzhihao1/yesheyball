# è€¶æ°å°çƒç½‘ç«™æµ‹è¯•é—®é¢˜æ”¹è¿›æ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025å¹´11æœˆ19æ—¥
**åŸºäº**: ã€Šè€¶æ°å°çƒç½‘ç«™éªŒæ”¶æµ‹è¯•è®°å½•ã€‹

---

## æ‰§è¡Œæ‘˜è¦

æœ¬æ”¹è¿›æ–¹æ¡ˆæ—¨åœ¨è§£å†³éªŒæ”¶æµ‹è¯•ä¸­å‘ç°çš„**P0çº§æ•°æ®çŸ›ç›¾é—®é¢˜**å’Œ**P1çº§ç”¨æˆ·ä½“éªŒé—®é¢˜**ã€‚æ–¹æ¡ˆé‡‡ç”¨äº”æ­¥ç³»ç»ŸåŒ–æµç¨‹ï¼Œä»æ ¹æœ¬åŸå› åˆ†æåˆ°è¯¦ç»†å®æ–½è®¡åˆ’ï¼Œç¡®ä¿é—®é¢˜å½»åº•è§£å†³ä¸”ä¸å¼•å…¥æ–°é£é™©ã€‚

### é—®é¢˜æ¦‚è§ˆ

| ä¼˜å…ˆçº§ | é—®é¢˜æè¿° | å½±å“èŒƒå›´ | ä¿®å¤çŠ¶æ€ |
|:---:|:---|:---|:---|
| **P0** | æ•°æ®çŸ›ç›¾ï¼š"å·²åšæŒ4å¤©" vs "è¿ç»­è®­ç»ƒ0å¤©ï¼Œæœ€é•¿2å¤©" | ä¸¥é‡æŸå®³äº§å“å¯ä¿¡åº¦ | å¾…ä¿®å¤ |
| **P1** | é‡å¤æäº¤è®­ç»ƒæ— å‹å¥½é”™è¯¯æç¤º | ç”¨æˆ·ä½“éªŒé—®é¢˜ï¼Œç•Œé¢æ— åé¦ˆ | å¾…ä¿®å¤ |

---

## ä¸€ã€é—®é¢˜æ ¹æœ¬åŸå› åˆ†æ

### P0é—®é¢˜ï¼šæ•°æ®çŸ›ç›¾

**ç°è±¡**:
- 90å¤©æŒ‘æˆ˜å¡ç‰‡æ˜¾ç¤ºï¼š"å·²åšæŒ4å¤©"
- å°å¡ç‰‡æ˜¾ç¤ºï¼š"è¿ç»­è®­ç»ƒ0å¤©ï¼Œæœ€é•¿2å¤©"

**æ ¹æœ¬åŸå› **:
1. **æ•°æ®è®¡ç®—é€»è¾‘åˆ†æ•£**ï¼šä¸¤ä¸ªä¸åŒçš„APIç«¯ç‚¹ä½¿ç”¨ä¸åŒçš„è®¡ç®—é€»è¾‘
   - `/api/user/streak` - å¯èƒ½è¯»å–é¢„è®¡ç®—å­—æ®µæˆ–èšåˆæ•°æ®
   - `/api/ninety-day/progress` - å¯èƒ½ä»åŸå§‹è®­ç»ƒè®°å½•å®æ—¶è®¡ç®—
2. **æ•°æ®æºä¸ç»Ÿä¸€**ï¼š
   - ä¸€ä¸ªå¯èƒ½åŸºäº `users` è¡¨çš„ç¼“å­˜å­—æ®µ
   - å¦ä¸€ä¸ªå¯èƒ½åŸºäº `trainingSessions` è¡¨çš„å®æ—¶è®¡ç®—
3. **"è¿ç»­è®­ç»ƒ"å®šä¹‰ä¸æ˜ç¡®**ï¼š
   - 90å¤©æŒ‘æˆ˜ç³»ç»Ÿçš„"å·²åšæŒ"ä¸æ•´ä½“è®­ç»ƒç³»ç»Ÿçš„"è¿ç»­è®­ç»ƒ"æ¦‚å¿µæ··æ·†
   - ç¼ºä¹ç»Ÿä¸€çš„æ•°æ®å­—å…¸

### P1é—®é¢˜ï¼šé‡å¤æäº¤æ— æç¤º

**ç°è±¡**:
```
æ§åˆ¶å°é”™è¯¯ï¼šError: duplicate key value violates unique constraint "unique_user_day"
ç”¨æˆ·ç•Œé¢ï¼šæ— ä»»ä½•åé¦ˆ
```

**æ ¹æœ¬åŸå› **:
1. **åç«¯çº¦æŸç”Ÿæ•ˆä½†å‰ç«¯æœªå¤„ç†**ï¼šæ•°æ®åº“æ­£ç¡®é˜»æ­¢é‡å¤æäº¤ï¼Œä½†é”™è¯¯æœªä¼ é€’åˆ°å‰ç«¯
2. **ç¼ºå°‘é”™è¯¯æ˜ å°„**ï¼šå‰ç«¯æ²¡æœ‰å°†ç‰¹å®šé”™è¯¯ç æ˜ å°„ä¸ºå‹å¥½æç¤º
3. **ç¼ºå°‘æäº¤çŠ¶æ€ç®¡ç†**ï¼šæŒ‰é’®æœªåœ¨æäº¤æœŸé—´ç¦ç”¨ï¼Œç”¨æˆ·å¯èƒ½è¿ç»­ç‚¹å‡»

---

## äºŒã€æŠ€æœ¯ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šP0é—®é¢˜ä¿®å¤ï¼ˆæ•°æ®çŸ›ç›¾ï¼‰

#### 1. ç»Ÿä¸€æ•°æ®æ¨¡å‹è®¾è®¡

**æ ¸å¿ƒå†³ç­–**ï¼šå»ºç«‹å•ä¸€æ•°æ®æºï¼ˆSingle Source of Truthï¼‰

**æ•°æ®åº“Schemaä¿®æ”¹**:
```sql
-- åœ¨ users è¡¨å¢åŠ ç¼“å­˜å­—æ®µ
ALTER TABLE users
ADD COLUMN current_streak INTEGER DEFAULT 0,
ADD COLUMN longest_streak INTEGER DEFAULT 0;

CREATE INDEX idx_users_current_streak ON users(current_streak);
CREATE INDEX idx_users_longest_streak ON users(longest_streak);
```

#### 2. åˆ›å»ºç»Ÿä¸€çš„è®¡ç®—æœåŠ¡

**æ–°å»ºæ–‡ä»¶**: `server/services/trainingStatsService.ts`

```typescript
import { db } from '../db.js';
import { users, trainingSessions } from '../db/schema.js';
import { eq, desc } from 'drizzle-orm';

/**
 * æ›´æ–°ç”¨æˆ·è®­ç»ƒç»Ÿè®¡æ•°æ®ï¼ˆè¿ç»­å¤©æ•°ã€æœ€é•¿è¿ç»­å¤©æ•°ï¼‰
 *
 * æ ¸å¿ƒé€»è¾‘ï¼š
 * 1. ä» trainingSessions è¡¨è·å–æ‰€æœ‰è®­ç»ƒè®°å½•
 * 2. ç»Ÿä¸€è½¬æ¢ä¸ºUTCæ—¥æœŸï¼ˆé¿å…æ—¶åŒºé—®é¢˜ï¼‰
 * 3. å»é‡å¹¶æ’åº
 * 4. è®¡ç®— currentStreak å’Œ longestStreak
 * 5. æ›´æ–° users è¡¨
 */
export async function updateUserTrainingStats(userId: string): Promise<void> {
  try {
    // 1. è·å–ç”¨æˆ·æ‰€æœ‰è®­ç»ƒè®°å½•
    const sessions = await db
      .select()
      .from(trainingSessions)
      .where(eq(trainingSessions.userId, userId))
      .orderBy(desc(trainingSessions.createdAt));

    if (sessions.length === 0) {
      // æ— è®­ç»ƒè®°å½•ï¼Œé‡ç½®ä¸º0
      await db
        .update(users)
        .set({ currentStreak: 0, longestStreak: 0 })
        .where(eq(users.id, userId));
      return;
    }

    // 2. è½¬æ¢ä¸ºUTCæ—¥æœŸå­—ç¬¦ä¸²å¹¶å»é‡
    const uniqueDates = new Set<string>();
    sessions.forEach(session => {
      const date = new Date(session.createdAt);
      const utcDateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD
      uniqueDates.add(utcDateStr);
    });

    // 3. è½¬æ¢ä¸ºæ—¥æœŸå¯¹è±¡å¹¶æ’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰
    const sortedDates = Array.from(uniqueDates)
      .map(dateStr => new Date(dateStr))
      .sort((a, b) => b.getTime() - a.getTime());

    // 4. è®¡ç®—è¿ç»­å¤©æ•°
    let currentStreak = 0;
    let longestStreak = 0;
    let tempStreak = 1;

    const today = new Date();
    today.setUTCHours(0, 0, 0, 0);

    const yesterday = new Date(today);
    yesterday.setUTCDate(yesterday.getUTCDate() - 1);

    // æ£€æŸ¥æœ€è¿‘çš„è®­ç»ƒæ˜¯ä»Šå¤©è¿˜æ˜¯æ˜¨å¤©
    const latestDate = sortedDates[0];
    latestDate.setUTCHours(0, 0, 0, 0);

    if (latestDate.getTime() === today.getTime() || latestDate.getTime() === yesterday.getTime()) {
      currentStreak = 1;

      // å‘å‰éå†è®¡ç®—è¿ç»­å¤©æ•°
      for (let i = 1; i < sortedDates.length; i++) {
        const prevDate = new Date(sortedDates[i]);
        prevDate.setUTCHours(0, 0, 0, 0);

        const currentDate = new Date(sortedDates[i - 1]);
        currentDate.setUTCHours(0, 0, 0, 0);

        const diffDays = Math.floor((currentDate.getTime() - prevDate.getTime()) / (1000 * 60 * 60 * 24));

        if (diffDays === 1) {
          currentStreak++;
          tempStreak++;
        } else {
          break;
        }
      }

      longestStreak = Math.max(currentStreak, tempStreak);
    } else {
      // æœ€è¿‘è®­ç»ƒä¸åœ¨æ˜¨å¤©æˆ–ä»Šå¤©ï¼Œè¿ç»­å¤©æ•°ä¸­æ–­
      currentStreak = 0;
    }

    // è®¡ç®—å†å²æœ€é•¿è¿ç»­å¤©æ•°
    tempStreak = 1;
    for (let i = 1; i < sortedDates.length; i++) {
      const prevDate = new Date(sortedDates[i]);
      prevDate.setUTCHours(0, 0, 0, 0);

      const currentDate = new Date(sortedDates[i - 1]);
      currentDate.setUTCHours(0, 0, 0, 0);

      const diffDays = Math.floor((currentDate.getTime() - prevDate.getTime()) / (1000 * 60 * 60 * 24));

      if (diffDays === 1) {
        tempStreak++;
        longestStreak = Math.max(longestStreak, tempStreak);
      } else {
        tempStreak = 1;
      }
    }

    // 5. æ›´æ–°æ•°æ®åº“
    await db
      .update(users)
      .set({
        currentStreak,
        longestStreak,
        updatedAt: new Date()
      })
      .where(eq(users.id, userId));

    console.log(`[TrainingStatsService] Updated stats for user ${userId}: currentStreak=${currentStreak}, longestStreak=${longestStreak}`);

  } catch (error) {
    console.error(`[TrainingStatsService] Error updating stats for user ${userId}:`, error);
    throw error;
  }
}
```

#### 3. åˆ›å»ºç»Ÿä¸€çš„APIç«¯ç‚¹

**ä¿®æ”¹æ–‡ä»¶**: `server/routes.ts`

```typescript
// æ–°å¢ç»Ÿä¸€çš„ç”¨æˆ·ç»Ÿè®¡API
app.get('/api/user/stats', isAuthenticated, async (req, res) => {
  try {
    const userId = req.user!.id;

    const user = await db
      .select({
        currentStreak: users.currentStreak,
        longestStreak: users.longestStreak,
        level: users.level,
        exp: users.exp,
        totalDays: users.totalDays,
        completedTasks: users.completedTasks,
      })
      .from(users)
      .where(eq(users.id, userId))
      .limit(1);

    if (!user || user.length === 0) {
      return res.status(404).json({ error: 'User not found' });
    }

    res.json({
      currentStreak: user[0].currentStreak || 0,
      longestStreak: user[0].longestStreak || 0,
      level: user[0].level || 1,
      exp: user[0].exp || 0,
      totalDays: user[0].totalDays || 0,
      completedTasks: user[0].completedTasks || 0,
    });
  } catch (error) {
    console.error('[API /user/stats] Error:', error);
    res.status(500).json({ error: 'Failed to fetch user stats' });
  }
});
```

#### 4. åœ¨è®­ç»ƒæäº¤æ—¶è§¦å‘æ›´æ–°

**ä¿®æ”¹æ–‡ä»¶**: `server/routes.ts` (è®­ç»ƒè®°å½•æäº¤æ¥å£)

```typescript
// åœ¨ POST /api/ninety-day/records æˆ– POST /api/training-sessions ä¸­æ·»åŠ 
import { updateUserTrainingStats } from './services/trainingStatsService.js';

// åœ¨æˆåŠŸæ’å…¥è®­ç»ƒè®°å½•å
await updateUserTrainingStats(userId);
```

#### 5. å‰ç«¯ç»Ÿä¸€è°ƒç”¨æ–°API

**ä¿®æ”¹æ–‡ä»¶**: `client/src/hooks/useUserStats.ts` (æ–°å»ºæˆ–æ›¿æ¢æ—§hook)

```typescript
import { useQuery } from '@tanstack/react-query';

interface UserStats {
  currentStreak: number;
  longestStreak: number;
  level: number;
  exp: number;
  totalDays: number;
  completedTasks: number;
}

export function useUserStats() {
  return useQuery<UserStats>({
    queryKey: ['/api/user/stats'],
    queryFn: async () => {
      const response = await fetch('/api/user/stats', {
        credentials: 'include',
      });
      if (!response.ok) {
        throw new Error('Failed to fetch user stats');
      }
      return response.json();
    },
    staleTime: 1000 * 60 * 5, // 5åˆ†é’Ÿç¼“å­˜
  });
}
```

**æ›¿æ¢æ‰€æœ‰ä½¿ç”¨æ—§APIçš„ç»„ä»¶**:
- `client/src/pages/NinetyDayChallenge.tsx` - æ›¿æ¢ `useUserStreak()` ä¸º `useUserStats()`
- `client/src/pages/profile.tsx` - ç»Ÿä¸€ä½¿ç”¨ `useUserStats()`
- å…¶ä»–æ˜¾ç¤ºè¿ç»­å¤©æ•°çš„ç»„ä»¶

---

### æ–¹æ¡ˆBï¼šP1é—®é¢˜ä¿®å¤ï¼ˆé‡å¤æäº¤æç¤ºï¼‰

#### 1. å‰ç«¯é˜²æŠ¤ï¼šç¦ç”¨æŒ‰é’® + çŠ¶æ€ç®¡ç†

**ä¿®æ”¹æ–‡ä»¶**: `client/src/components/ninety-day/TrainingModal.tsx`

```typescript
import { useState } from 'react';
import { v4 as uuidv4 } from 'uuid';

export function TrainingModal({ onSubmit, curriculum, isSubmitting }) {
  const [submitError, setSubmitError] = useState<string | null>(null);

  const handleSubmit = async (formData) => {
    if (isSubmitting) return; // é˜²æ­¢é‡å¤ç‚¹å‡»

    setSubmitError(null);
    const idempotencyKey = uuidv4(); // ç”Ÿæˆå¹‚ç­‰æ€§Key

    try {
      const response = await fetch('/api/ninety-day/records', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Idempotency-Key': idempotencyKey,
        },
        credentials: 'include',
        body: JSON.stringify(formData),
      });

      if (response.status === 409) {
        // é‡å¤æäº¤
        const data = await response.json();
        setSubmitError(data.message || 'ä»Šæ—¥è®­ç»ƒå·²å®Œæˆï¼Œæ˜å¤©å†æ¥å§ï¼ğŸ‰');
        return;
      }

      if (!response.ok) {
        throw new Error('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }

      const result = await response.json();
      onSubmit(result);
    } catch (error) {
      setSubmitError(error.message);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      {/* è¡¨å•å­—æ®µ */}
      <button
        type="submit"
        disabled={isSubmitting}
        className={isSubmitting ? 'opacity-50 cursor-not-allowed' : ''}
      >
        {isSubmitting ? 'æäº¤ä¸­...' : 'æäº¤è®­ç»ƒè®°å½•'}
      </button>

      {submitError && (
        <div className="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
          <p className="text-amber-800 text-sm">{submitError}</p>
        </div>
      )}
    </form>
  );
}
```

#### 2. åç«¯é˜²æŠ¤ï¼šå¹‚ç­‰æ€§æ£€æŸ¥

**æ•°æ®åº“è¿ç§»**:
```sql
-- ä¸º ninety_day_training_records è¡¨æ·»åŠ å¹‚ç­‰æ€§å­—æ®µ
ALTER TABLE ninety_day_training_records
ADD COLUMN idempotency_key VARCHAR(36) UNIQUE;

CREATE INDEX idx_ninety_day_records_idempotency_key
ON ninety_day_training_records(idempotency_key);
```

**ä¿®æ”¹æ–‡ä»¶**: `server/routes.ts` (è®­ç»ƒè®°å½•æäº¤æ¥å£)

```typescript
app.post('/api/ninety-day/records', isAuthenticated, async (req, res) => {
  const idempotencyKey = req.headers['idempotency-key'];
  const userId = req.user!.id;

  if (!idempotencyKey) {
    return res.status(400).json({
      error: 'Idempotency-Key header is required'
    });
  }

  try {
    // æ£€æŸ¥å¹‚ç­‰æ€§Keyæ˜¯å¦å·²å­˜åœ¨
    const existingRecord = await db
      .select()
      .from(ninetyDayTrainingRecords)
      .where(eq(ninetyDayTrainingRecords.idempotencyKey, idempotencyKey))
      .limit(1);

    if (existingRecord.length > 0) {
      // é‡å¤è¯·æ±‚ï¼Œè¿”å›åŸå§‹ç»“æœ
      return res.status(409).json({
        message: 'ä»Šæ—¥è®­ç»ƒå·²å®Œæˆï¼Œæ˜å¤©å†æ¥å§ï¼',
        data: existingRecord[0]
      });
    }

    // æ£€æŸ¥æ˜¯å¦å·²æœ‰ä»Šæ—¥è®°å½•ï¼ˆåŸºäºä¸šåŠ¡é€»è¾‘ï¼‰
    const today = new Date().toISOString().split('T')[0];
    const todayRecord = await db
      .select()
      .from(ninetyDayTrainingRecords)
      .where(
        and(
          eq(ninetyDayTrainingRecords.userId, userId),
          eq(ninetyDayTrainingRecords.dayNumber, req.body.dayNumber)
        )
      )
      .limit(1);

    if (todayRecord.length > 0) {
      return res.status(409).json({
        message: 'ä»Šæ—¥è®­ç»ƒå·²å®Œæˆï¼Œæ˜å¤©å†æ¥å§ï¼',
        data: todayRecord[0]
      });
    }

    // æ–°è¯·æ±‚ï¼Œæ­£å¸¸å¤„ç†
    const newRecord = await db
      .insert(ninetyDayTrainingRecords)
      .values({
        ...req.body,
        userId,
        idempotencyKey,
      })
      .returning();

    // è§¦å‘ç»Ÿè®¡æ•°æ®æ›´æ–°
    await updateUserTrainingStats(userId);

    res.status(201).json({
      message: 'è®­ç»ƒè®°å½•æäº¤æˆåŠŸï¼',
      data: newRecord[0]
    });

  } catch (error) {
    // å¤„ç†å¹¶å‘æƒ…å†µä¸‹çš„UNIQUEçº¦æŸå†²çª
    if (error.code === '23505') {
      return res.status(409).json({
        message: 'ä»Šæ—¥è®­ç»ƒå·²å®Œæˆï¼Œæ˜å¤©å†æ¥å§ï¼'
      });
    }

    console.error('[API /ninety-day/records] Error:', error);
    res.status(500).json({ error: 'æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' });
  }
});
```

---

## ä¸‰ã€æ•°æ®åº“è¿ç§»æ‰§è¡Œè®¡åˆ’

### è¿ç§»è„šæœ¬

**æ–‡ä»¶**: `migrations/YYYYMMDD_add_training_stats_fields.sql`

```sql
-- ============================================================================
-- Migration: Add training stats fields to users table
-- Purpose: Support unified training statistics calculation
-- Date: 2025-11-19
-- ============================================================================

BEGIN;

-- 1. ä¸º users è¡¨æ·»åŠ ç»Ÿè®¡å­—æ®µ
ALTER TABLE users
ADD COLUMN IF NOT EXISTS current_streak INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS longest_streak INTEGER DEFAULT 0;

-- 2. åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_users_current_streak ON users(current_streak);
CREATE INDEX IF NOT EXISTS idx_users_longest_streak ON users(longest_streak);

-- 3. ä¸º ninety_day_training_records è¡¨æ·»åŠ å¹‚ç­‰æ€§å­—æ®µ
ALTER TABLE ninety_day_training_records
ADD COLUMN IF NOT EXISTS idempotency_key VARCHAR(36);

-- 4. æ·»åŠ å”¯ä¸€çº¦æŸ
CREATE UNIQUE INDEX IF NOT EXISTS idx_ninety_day_records_idempotency_key
ON ninety_day_training_records(idempotency_key)
WHERE idempotency_key IS NOT NULL;

COMMIT;

-- ============================================================================
-- Rollback Script (ä»…åœ¨éœ€è¦æ—¶æ‰§è¡Œ)
-- ============================================================================
-- BEGIN;
-- ALTER TABLE users DROP COLUMN IF EXISTS current_streak;
-- ALTER TABLE users DROP COLUMN IF EXISTS longest_streak;
-- ALTER TABLE ninety_day_training_records DROP COLUMN IF EXISTS idempotency_key;
-- COMMIT;
```

### æ•°æ®å›å¡«è„šæœ¬

**æ–‡ä»¶**: `scripts/backfill-training-stats.ts`

```typescript
import { db } from '../server/db.js';
import { users } from '../server/db/schema.js';
import { updateUserTrainingStats } from '../server/services/trainingStatsService.js';

async function backfillTrainingStats() {
  console.log('[Backfill] Starting training stats backfill...');

  try {
    // è·å–æ‰€æœ‰ç”¨æˆ·
    const allUsers = await db.select({ id: users.id }).from(users);
    console.log(`[Backfill] Found ${allUsers.length} users`);

    let successCount = 0;
    let errorCount = 0;

    // é€ä¸ªæ›´æ–°
    for (const user of allUsers) {
      try {
        await updateUserTrainingStats(user.id);
        successCount++;
        console.log(`[Backfill] âœ“ Updated user ${user.id} (${successCount}/${allUsers.length})`);
      } catch (error) {
        errorCount++;
        console.error(`[Backfill] âœ— Failed to update user ${user.id}:`, error);
      }
    }

    console.log(`[Backfill] Complete! Success: ${successCount}, Errors: ${errorCount}`);
  } catch (error) {
    console.error('[Backfill] Fatal error:', error);
    process.exit(1);
  }
}

backfillTrainingStats();
```

**æ‰§è¡Œæ–¹å¼**:
```bash
npx tsx scripts/backfill-training-stats.ts
```

---

## å››ã€æµ‹è¯•éªŒè¯è®¡åˆ’

### 1. å•å…ƒæµ‹è¯•

**æ–‡ä»¶**: `server/services/trainingStatsService.test.ts`

```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import { updateUserTrainingStats } from './trainingStatsService';

describe('TrainingStatsService', () => {
  it('åº”è¯¥æ­£ç¡®è®¡ç®—è¿ç»­è®­ç»ƒå¤©æ•°', async () => {
    // æµ‹è¯•ç”¨ä¾‹...
  });

  it('åº”è¯¥å¤„ç†è·¨æ—¶åŒºçš„è®­ç»ƒè®°å½•', async () => {
    // æµ‹è¯•ç”¨ä¾‹...
  });

  it('å½“æ— è®­ç»ƒè®°å½•æ—¶åº”è¯¥é‡ç½®ä¸º0', async () => {
    // æµ‹è¯•ç”¨ä¾‹...
  });
});
```

### 2. é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯**:
1. æäº¤è®­ç»ƒè®°å½• â†’ éªŒè¯ `currentStreak` å’Œ `longestStreak` æ›´æ–°æ­£ç¡®
2. è¿ç»­ä¸¤å¤©æäº¤ â†’ éªŒè¯è¿ç»­å¤©æ•°é€’å¢
3. ä¸­æ–­åå†æäº¤ â†’ éªŒè¯è¿ç»­å¤©æ•°é‡ç½®
4. å¿«é€Ÿè¿ç»­ç‚¹å‡»æäº¤æŒ‰é’® â†’ éªŒè¯åªåˆ›å»ºä¸€æ¡è®°å½•

### 3. æ‰‹åŠ¨QAæµ‹è¯•æ¸…å•

**P0é—®é¢˜éªŒè¯**:
- [ ] 90å¤©æŒ‘æˆ˜å¡ç‰‡ä¸å°å¡ç‰‡æ˜¾ç¤ºçš„è¿ç»­å¤©æ•°ä¸€è‡´
- [ ] Profileé¡µé¢çš„è¿ç»­å¤©æ•°ä¸ä¸Šè¿°ä¸€è‡´
- [ ] æäº¤è®­ç»ƒåï¼Œæ‰€æœ‰é¡µé¢çš„è¿ç»­å¤©æ•°åŒæ­¥æ›´æ–°
- [ ] è·¨å¤©åè®¿é—®ï¼Œè¿ç»­å¤©æ•°è®¡ç®—æ­£ç¡®

**P1é—®é¢˜éªŒè¯**:
- [ ] é¦–æ¬¡æäº¤è®­ç»ƒæˆåŠŸï¼Œæ˜¾ç¤ºæˆåŠŸæç¤º
- [ ] é‡å¤æäº¤åŒä¸€å¤©è®­ç»ƒï¼Œæ˜¾ç¤ºå‹å¥½é”™è¯¯æç¤º
- [ ] æäº¤æŒ‰é’®åœ¨æäº¤æœŸé—´è¢«ç¦ç”¨
- [ ] ç½‘ç»œæ…¢æ—¶ï¼ŒæŒ‰é’®ä¿æŒç¦ç”¨å’ŒåŠ è½½çŠ¶æ€

---

## äº”ã€ä¸Šçº¿éƒ¨ç½²è®¡åˆ’

### éƒ¨ç½²æ—¶é—´çª—å£
- **å»ºè®®æ—¶é—´**: å‡Œæ™¨ 2:00 - 4:00ï¼ˆç”¨æˆ·æ´»è·ƒåº¦æœ€ä½ï¼‰
- **é¢„è®¡æ—¶é•¿**: 30åˆ†é’Ÿï¼ˆå«éªŒè¯ï¼‰

### éƒ¨ç½²æ­¥éª¤

1. **T-30åˆ†é’Ÿï¼šå‡†å¤‡é˜¶æ®µ**
   - [ ] åˆ›å»ºç”Ÿäº§æ•°æ®åº“å®Œæ•´å¤‡ä»½
   - [ ] éªŒè¯å¤‡ä»½æ–‡ä»¶å¯ç”¨æ€§
   - [ ] ç¡®è®¤æ‰€æœ‰å›¢é˜Ÿæˆå‘˜åœ¨çº¿

2. **T-0ï¼šéƒ¨ç½²å¼€å§‹**
   - [ ] å®£å¸ƒ"éƒ¨ç½²å¼€å§‹"
   - [ ] æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬
   - [ ] æ‰§è¡Œæ•°æ®å›å¡«è„šæœ¬ï¼ˆç›‘æ§è¿›åº¦ï¼‰
   - [ ] éƒ¨ç½²æ–°ç‰ˆæœ¬ä»£ç 

3. **T+5åˆ†é’Ÿï¼šç«‹å³éªŒè¯**
   - [ ] æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ï¼Œæ— å¼‚å¸¸é”™è¯¯
   - [ ] è¿è¡Œè‡ªåŠ¨åŒ–å†’çƒŸæµ‹è¯•
   - [ ] æ‰‹åŠ¨éªŒè¯P0å’ŒP1é—®é¢˜ä¿®å¤

4. **T+30åˆ†é’Ÿï¼šæŒç»­ç›‘æ§**
   - [ ] ç›‘æ§é”™è¯¯ç‡ã€å“åº”æ—¶é—´
   - [ ] æ£€æŸ¥ç”¨æˆ·åé¦ˆæ¸ é“
   - [ ] å¦‚æœ‰é—®é¢˜ï¼Œå¯åŠ¨å›æ»š

5. **T+60åˆ†é’Ÿï¼šä¸Šçº¿å®Œæˆ**
   - [ ] å®£å¸ƒ"ä¸Šçº¿æˆåŠŸ"
   - [ ] æ›´æ–°é¡¹ç›®ç®¡ç†å·¥å…·çŠ¶æ€
   - [ ] é€šçŸ¥ç›¸å…³æ–¹

### å›æ»šè§¦å‘æ¡ä»¶
- è‡ªåŠ¨åŒ–æµ‹è¯•å¤±è´¥
- æ•°æ®éªŒè¯å‘ç°ä¸¥é‡ä¸ä¸€è‡´
- é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼ï¼ˆ5xx > 1%ï¼‰
- 30åˆ†é’Ÿå†…æ— æ³•å®ŒæˆéªŒè¯

### å¿«é€Ÿå›æ»šæ­¥éª¤
1. ç«‹å³å®£å¸ƒ"å¯åŠ¨å›æ»š"
2. é€šè¿‡éƒ¨ç½²ç³»ç»Ÿå›æ»šä»£ç 
3. ä»å¤‡ä»½æ¢å¤æ•°æ®åº“ï¼ˆå¦‚éœ€è¦ï¼‰
4. æ¸…ç©ºCDNç¼“å­˜
5. éªŒè¯åº”ç”¨æ¢å¤æ­£å¸¸

---

## å…­ã€é£é™©è¯„ä¼°

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|:---|:---:|:---:|:---|
| æ•°æ®å›å¡«è„šæœ¬é”™è¯¯æ±¡æŸ“ç”¨æˆ·æ•°æ® | ä¸­ | é«˜ | 1. åœ¨stagingå®Œæ•´æµ‹è¯•<br>2. å…ˆæ‰§è¡Œå°èŒƒå›´éªŒè¯<br>3. å®Œæ•´å¤‡ä»½å¯å¿«é€Ÿæ¢å¤ |
| æ–°æ—§APIåˆ‡æ¢å¯¼è‡´å‰ç«¯æŠ¥é”™ | ä½ | ä¸­ | 1. ä½¿ç”¨åŠŸèƒ½å¼€å…³<br>2. ä¿ç•™æ—§APIä¸€æ®µæ—¶é—´<br>3. å……åˆ†æµ‹è¯• |
| é«˜å¹¶å‘ä¸‹å¹‚ç­‰æ€§é€»è¾‘å¤±æ•ˆ | ä½ | ä¸­ | 1. æ•°æ®åº“UNIQUEçº¦æŸå…œåº•<br>2. å‹åŠ›æµ‹è¯•éªŒè¯<br>3. ç›‘æ§é‡å¤è¯·æ±‚ç‡ |
| æ—¶åŒºå¤„ç†é€»è¾‘é”™è¯¯ | ä¸­ | ä¸­ | 1. ç»Ÿä¸€ä½¿ç”¨UTC<br>2. å•å…ƒæµ‹è¯•è¦†ç›–è¾¹ç•Œæƒ…å†µ<br>3. å¤šæ—¶åŒºç”¨æˆ·éªŒè¯ |

---

## ä¸ƒã€æˆåŠŸæ ‡å‡†

### å®šé‡æŒ‡æ ‡
- [ ] P0é—®é¢˜ï¼šæ‰€æœ‰é¡µé¢æ•°æ®ä¸€è‡´æ€§ = 100%
- [ ] P1é—®é¢˜ï¼šé‡å¤æäº¤æ˜¾ç¤ºå‹å¥½æç¤º = 100%
- [ ] æ•°æ®å›å¡«æˆåŠŸç‡ â‰¥ 99.9%
- [ ] ä¸Šçº¿åé”™è¯¯ç‡å¢é•¿ < 0.1%
- [ ] ç”¨æˆ·æŠ•è¯‰å‡å°‘ > 80%

### å®šæ€§æŒ‡æ ‡
- [ ] ç”¨æˆ·åé¦ˆï¼šä¸å†æŠ¥å‘Šæ•°æ®çŸ›ç›¾é—®é¢˜
- [ ] å¼€å‘å›¢é˜Ÿï¼šç¡®è®¤æ•°æ®æ¨¡å‹ç»Ÿä¸€ã€ä»£ç æ¸…æ™°
- [ ] æµ‹è¯•å›¢é˜Ÿï¼šéªŒæ”¶æµ‹è¯•å…¨éƒ¨é€šè¿‡

---

## å…«ã€åç»­ä¼˜åŒ–å»ºè®®

1. **å»ºç«‹æ•°æ®å­—å…¸**ï¼šæ˜ç¡®å®šä¹‰æ‰€æœ‰è®­ç»ƒç›¸å…³æŒ‡æ ‡çš„è®¡ç®—è§„åˆ™
2. **APIè®¾è®¡è§„èŒƒ**ï¼šåˆ¶å®šAPIè®¾è®¡å’Œç‰ˆæœ¬ç®¡ç†è§„èŒƒï¼Œé¿å…ç±»ä¼¼é—®é¢˜
3. **å‰ç«¯çŠ¶æ€ç®¡ç†ä¼˜åŒ–**ï¼šè€ƒè™‘å¼•å…¥å…¨å±€çŠ¶æ€ç®¡ç†ï¼Œå‡å°‘é‡å¤è¯·æ±‚
4. **ç›‘æ§å‘Šè­¦**ï¼šå¢åŠ æ•°æ®ä¸€è‡´æ€§ç›‘æ§ï¼Œè‡ªåŠ¨å‘ç°å¼‚å¸¸

---

## é™„å½•

### A. ç›¸å…³æ–‡æ¡£
- ã€Šè€¶æ°å°çƒç½‘ç«™éªŒæ”¶æµ‹è¯•è®°å½•ã€‹
- `CLAUDE.md` - é¡¹ç›®æŠ€æœ¯æ–‡æ¡£

### B. è”ç³»äºº
- é¡¹ç›®ç»ç†ï¼š[å¾…å¡«å†™]
- åç«¯è´Ÿè´£äººï¼š[å¾…å¡«å†™]
- å‰ç«¯è´Ÿè´£äººï¼š[å¾…å¡«å†™]
- æµ‹è¯•è´Ÿè´£äººï¼š[å¾…å¡«å†™]

### C. å˜æ›´å†å²
| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´è¯´æ˜ | ä½œè€… |
|:---:|:---|:---|:---|
| v1.0 | 2025-11-19 | åˆå§‹ç‰ˆæœ¬ | Claude Code |

---

**æ–‡æ¡£ç»“æŸ**
