-- ============================================================================
-- V2.1 Training System: Level 7 Training Units Import
-- ============================================================================
-- 导入Level 7 (综合提升 - 高级技能) 的6个训练单元
-- 前置条件: 需要先执行 11_create_subskills_level4_8.sql 创建子技能
-- 作者: 耶氏台球学院
-- 日期: 2025-01-10
-- ============================================================================

-- 开始事务
BEGIN;

-- ============================================================================
-- 子技能 7.1: 特殊技术掌握 (3单元)
-- ============================================================================

-- ----------------------------------------------------------------------------
-- Unit 1: 角度球精准瞄准
-- ----------------------------------------------------------------------------
INSERT INTO training_units (sub_skill_id, unit_type, unit_order, title, content, xp_reward, estimated_minutes)
SELECT
    ss.id,
    'practice',
    1,
    '角度球精准瞄准',
    jsonb_build_object(
        'theory', '角度球（cut shot）是台球中最常见的球型，掌握精准瞄准是高手的标志。角度球分为：

向边球（向库边切球）：
- 角度通常在0-60度
- 需要考虑目标球吃库后的轨迹
- 瞄准难度较大
- 容易判断是否进袋

离边球（离开库边切球）：
- 角度通常在30-90度
- 不考虑吃库因素
- 瞄准相对容易
- 需要精确的切球点判断

极限角度球（大于75度）：
- 需要极薄的切球
- 对瞄准线的要求极高
- 心理压力大
- 成功率较低，但观赏性强

瞄准方法：
1. 假想球法：在脑海中想象白球位置
2. 重心线法：连接白球和目标球重心
3. 对点法：找到目标球上的切点
4. 分数法：角度对应切球厚薄（1/2球、1/3球等）',
        'steps', ARRAY[
            '理论学习：',
            '  - 学习4种瞄准方法',
            '  - 理解不同角度的难度差异',
            '练习向边球（20次）：',
            '  - 30度、45度、60度各练习',
            '  - 观察目标球吃库轨迹',
            '练习离边球（20次）：',
            '  - 45度、60度、75度各练习',
            '  - 体会不同角度的切球感觉',
            '挑战极限角度（10次）：',
            '  - 80度以上角度球',
            '  - 体验薄切的难度'
        ],
        'tips', ARRAY[
            '从45度标准角度开始练习',
            '每种角度至少练习20次建立肌肉记忆',
            '瞄准时要考虑白球的大小（目标球看起来被挡住一部分）',
            '角度越大越需要慢速出杆',
            '可以用粉笔在目标球上标记理论切点',
            '职业选手的角度球成功率也只有80-90%'
        ],
        'common_mistakes', ARRAY[
            '瞄准方法混淆，没有统一体系',
            '过度依赖直觉，忽略科学瞄准',
            '极限角度球信心不足',
            '出杆不够笔直，产生侧旋',
            '没有根据角度调整出杆速度'
        ],
        'practice_requirements', '完成50次角度球练习：向边球20次、离边球20次、极限角度10次，记录成功率',
        'success_criteria', '45度角度球成功率达到80%，60度成功率达到70%，75度成功率达到50%',
        'related_courses', ARRAY[19, 20, 22]
    ),
    20,
    20
FROM sub_skills ss
JOIN training_skills s ON ss.skill_id = s.id
WHERE s.skill_name = '高级技术' AND ss.sub_skill_name = '特殊技术掌握'
ON CONFLICT DO NOTHING;

-- ----------------------------------------------------------------------------
-- Unit 2: 中袋球特训
-- ----------------------------------------------------------------------------
INSERT INTO training_units (sub_skill_id, unit_type, unit_order, title, content, xp_reward, estimated_minutes)
SELECT
    ss.id,
    'practice',
    2,
    '中袋球特训',
    jsonb_build_object(
        'theory', '中袋球（middle pocket shot）是台球中难度最大的进球之一。中袋的有效进球宽度比底袋和顶袋都小，需要极高的瞄准精度。

中袋球的难点：
1. 进球角度窄（有效角度约20-30度）
2. 容易被库边嘴卡住
3. 心理压力大
4. 距离判断要求高

中袋球分类：
- 直中袋（0-15度）：相对容易
- 斜中袋（15-30度）：难度中等
- 大角度中袋（30度以上）：极高难度

提高中袋球成功率的要点：
- 精确瞄准：误差不能超过3mm
- 稳定出杆：任何晃动都会失败
- 力量适中：过大过小都会影响进球线
- 心态平稳：不能紧张',
        'steps', ARRAY[
            '直中袋练习（15次）：',
            '  - 白球和目标球正对中袋',
            '  - 距离30cm、50cm、70cm各5次',
            '  - 建立进球信心',
            '斜中袋练习（15次）：',
            '  - 15度、20度、25度角各5次',
            '  - 体会角度对进球线的影响',
            '大角度中袋挑战（10次）：',
            '  - 30度以上角度',
            '  - 体验极限难度',
            '移动中袋（10次）：',
            '  - 白球在不同位置',
            '  - 模拟实战场景'
        ],
        'tips', ARRAY[
            '中袋球最重要的是瞄准，其次是稳定',
            '可以用白球在中袋边反复练习瞄准线',
            '出杆速度要适中，不能过快',
            '距离越远难度越高，初期练习近距离',
            '观察职业选手对中袋球的态度（通常都很谨慎）',
            '不要期望过高成功率，60%就是很好的水平'
        ],
        'common_mistakes', ARRAY[
            '瞄准不够精确',
            '出杆不够稳定',
            '力量过大或过小',
            '心理紧张导致动作变形',
            '没有充分的试杆'
        ],
        'practice_requirements', '完成50次中袋球练习：直中袋15次、斜中袋15次、大角度10次、移动10次',
        'success_criteria', '直中袋成功率达到80%，斜中袋（20度内）成功率达到60%，能够自信应对中袋球',
        'related_courses', ARRAY[21, 23]
    ),
    20,
    20
FROM sub_skills ss
JOIN training_skills s ON ss.skill_id = s.id
WHERE s.skill_name = '高级技术' AND ss.sub_skill_name = '特殊技术掌握'
ON CONFLICT DO NOTHING;

-- ----------------------------------------------------------------------------
-- Unit 3: 特殊球型技术
-- ----------------------------------------------------------------------------
INSERT INTO training_units (sub_skill_id, unit_type, unit_order, title, content, xp_reward, estimated_minutes)
SELECT
    ss.id,
    'practice',
    3,
    '特殊球型技术',
    jsonb_build_object(
        'theory', '特殊球型技术包括弧线球、翻腕技术和其他高级技巧。这些技术在特定场景下能够解决常规方法无法完成的球：

弧线球（Curve/Masse）：
- 击打白球侧下方，使白球产生弧线轨迹
- 用于绕过障碍球
- 难度极高，需要专门练习
- 存在台面损伤风险

翻腕技术：
- 击球瞬间手腕翻转
- 增加穿透力和控制力
- 提高击球稳定性
- 是一种高级的发力技巧

贴库球技术：
- 白球或目标球紧贴库边
- 需要特殊的瞄准和出杆角度
- 手架调整困难

这些技术不是必须掌握，但学习后能够：
- 扩展技术储备
- 增加解球手段
- 提高比赛竞争力
- 增强台球理解',
        'steps', ARRAY[
            '翻腕技术练习：',
            '  - 学习翻腕的正确时机和幅度',
            '  - 在定杆中练习翻腕动作',
            '  - 体会穿透力的变化',
            '  - 练习15次',
            '弧线球入门：',
            '  - 了解弧线球原理（不要求掌握）',
            '  - 尝试轻微弧线（击打侧下方）',
            '  - 体验白球弧线轨迹',
            '  - 练习10次',
            '贴库球处理：',
            '  - 练习白球贴库的击球',
            '  - 练习目标球贴库的瞄准',
            '  - 学习手架调整方法',
            '  - 练习15次'
        ],
        'tips', ARRAY[
            '翻腕要适度，不能过大',
            '弧线球有风险，不建议初学者强求',
            '贴库球关键是手架稳定',
            '这些技术需要长期练习才能掌握',
            '实战中优先考虑常规方法',
            '可以请教专业教练进行指导'
        ],
        'common_mistakes', ARRAY[
            '翻腕过度导致击球失控',
            '强行练习弧线球损坏台面',
            '贴库球手架不稳',
            '急于求成，基础不扎实就练习高难技术',
            '过度依赖特殊技术'
        ],
        'practice_requirements', '完成40次特殊技术练习：翻腕15次、弧线球10次、贴库球15次，重点体验不同技术的特点',
        'success_criteria', '理解特殊技术的原理和应用场景，能够完成基础的翻腕动作，掌握贴库球的基本处理方法',
        'related_courses', ARRAY[12, 41]
    ),
    20,
    25
FROM sub_skills ss
JOIN training_skills s ON ss.skill_id = s.id
WHERE s.skill_name = '高级技术' AND ss.sub_skill_name = '特殊技术掌握'
ON CONFLICT DO NOTHING;

-- ============================================================================
-- 子技能 7.2: 瞄准技术精进 (3单元)
-- ============================================================================

-- ----------------------------------------------------------------------------
-- Unit 4: 极限高球瞄准
-- ----------------------------------------------------------------------------
INSERT INTO training_units (sub_skill_id, unit_type, unit_order, title, content, xp_reward, estimated_minutes)
SELECT
    ss.id,
    'practice',
    4,
    '极限高球瞄准',
    jsonb_build_object(
        'theory', '极限高球（extreme thin cut）是指切球角度接近90度的球型，目标球只被白球轻微接触。这是台球中最难的进球之一，需要极高的瞄准精度和心理素质。

极限高球的特点：
- 切球角度75-89度
- 接触面积极小（不到1/10球）
- 目标球速度很慢
- 白球几乎不改变方向
- 心理压力巨大

瞄准方法：
1. 超薄切球法：瞄准目标球边缘的极限点
2. 白球边缘法：想象白球边缘刚好触碰目标球
3. 影子球法：在脑海中模拟极薄的重叠
4. 对比法：与已知角度对比调整

成功要素：
- 绝对稳定的手架
- 极慢的出杆速度
- 笔直的运杆路线
- 坚定的信心
- 反复的试杆',
        'steps', ARRAY[
            '80度角练习（10次）：',
            '  - 目标球距袋口40cm',
            '  - 白球与目标球距离30cm',
            '  - 感受薄切的感觉',
            '85度角练习（10次）：',
            '  - 进一步减小接触面积',
            '  - 观察目标球的缓慢移动',
            '  - 体会瞄准的精确度要求',
            '88度极限角（10次）：',
            '  - 几乎是平行切球',
            '  - 接受较低的成功率',
            '  - 建立对极限角的信心',
            '移动练习（10次）：',
            '  - 不同距离和位置',
            '  - 模拟实战场景'
        ],
        'tips', ARRAY[
            '极限高球的成功率本来就低，职业选手也只有50-60%',
            '出杆速度要极慢，快速出杆会导致白球跑偏',
            '试杆要多，至少5-7次',
            '瞄准时要极度专注，不能有任何干扰',
            '可以用练习球在台上反复尝试找到感觉',
            '心态要好，失败是正常的'
        ],
        'common_mistakes', ARRAY[
            '瞄准点位过厚或过薄',
            '出杆速度过快',
            '手架不够稳定',
            '试杆不充分',
            '心理压力导致动作变形',
            '对成功率期望过高'
        ],
        'practice_requirements', '完成40次极限高球练习：80度10次、85度10次、88度10次、移动10次，记录成功率',
        'success_criteria', '80度角成功率达到40%，85度角成功率达到25%，能够自信面对极限高球',
        'related_courses', ARRAY[19, 20, 23]
    ),
    20,
    20
FROM sub_skills ss
JOIN training_skills s ON ss.skill_id = s.id
WHERE s.skill_name = '高级技术' AND ss.sub_skill_name = '瞄准技术精进'
ON CONFLICT DO NOTHING;

-- ----------------------------------------------------------------------------
-- Unit 5: 瞄准锁定技术
-- ----------------------------------------------------------------------------
INSERT INTO training_units (sub_skill_id, unit_type, unit_order, title, content, xp_reward, estimated_minutes)
SELECT
    ss.id,
    'practice',
    5,
    '瞄准锁定技术',
    jsonb_build_object(
        'theory', '瞄准锁定是指在试杆后到击球前保持瞄准线不变的能力。很多球手在试杆时瞄准很准，但击球时瞄准线发生偏移，导致失误。瞄准锁定技术能够显著提高进球稳定性。

瞄准锁定的关键：
1. 视线锁定
   - 试杆时锁定瞄准点
   - 出杆前最后一次确认
   - 击球时视线不移动

2. 身体稳定
   - 试杆到击球过程中身体不动
   - 呼吸平稳
   - 肌肉保持相同张力

3. 心理锁定
   - 击球决心坚定
   - 不在最后时刻怀疑
   - 相信自己的瞄准

训练方法：
- 延时击球：试杆后停顿3秒再击球
- 闭眼击球：最后一次试杆后闭眼击球
- 标记练习：在台面标记瞄准线',
        'steps', ARRAY[
            '基础锁定练习：',
            '  1. 选择一个简单直球',
            '  2. 试杆5次，确认瞄准',
            '  3. 停顿3秒，保持瞄准不变',
            '  4. 击球并观察是否偏移',
            '  5. 重复15次',
            '角度球锁定：',
            '  1. 选择45度角度球',
            '  2. 试杆5次，找到切点',
            '  3. 停顿3秒，锁定瞄准',
            '  4. 击球检验',
            '  5. 重复15次',
            '压力测试：',
            '  1. 在有干扰的环境中练习',
            '  2. 限时击球（试杆后10秒内必须击球）',
            '  3. 连续击球（5球连续，中间不停顿）'
        ],
        'tips', ARRAY[
            '瞄准锁定需要大量练习才能形成肌肉记忆',
            '可以用心理暗示帮助锁定（如在心中默念''锁定''）',
            '呼吸节奏很重要：试杆时吸气，击球时呼气',
            '不要在击球前突然怀疑瞄准，要相信试杆的结果',
            '录像自己的练习，观察是否有瞄准偏移',
            '这项技术能够让你的成功率提高10-15%'
        ],
        'common_mistakes', ARRAY[
            '试杆和击球的瞄准线不一致',
            '击球前突然改变瞄准',
            '身体移动导致瞄准偏移',
            '视线在最后时刻移开',
            '心理紧张导致肌肉僵硬',
            '缺乏系统的锁定训练'
        ],
        'practice_requirements', '完成45次瞄准锁定练习：基础15次、角度球15次、压力测试15次，比较锁定前后的成功率变化',
        'success_criteria', '掌握瞄准锁定技术，在45度角度球中成功率提高10%以上，能够在压力下保持瞄准稳定',
        'related_courses', ARRAY[19, 22, 41]
    ),
    20,
    20
FROM sub_skills ss
JOIN training_skills s ON ss.skill_id = s.id
WHERE s.skill_name = '高级技术' AND ss.sub_skill_name = '瞄准技术精进'
ON CONFLICT DO NOTHING;

-- ----------------------------------------------------------------------------
-- Unit 6: 高级技术综合测试
-- ----------------------------------------------------------------------------
INSERT INTO training_units (sub_skill_id, unit_type, unit_order, title, content, xp_reward, estimated_minutes)
SELECT
    ss.id,
    'challenge',
    6,
    '高级技术综合测试',
    jsonb_build_object(
        'theory', '高级技术综合测试将检验你在Level 7学到的所有高级技能。测试包括12个高难度球型，涵盖：

测试内容：
- 各种角度球（30-85度）
- 中袋球（直线和角度）
- 特殊技术（贴库、翻腕）
- 瞄准锁定能力
- 心理素质

评分体系（满分150分）：
- 角度球测试（4个）：40分
- 中袋球测试（3个）：30分
- 极限高球测试（2个）：30分
- 特殊技术测试（2个）：20分
- 综合球型（1个）：30分

通过标准：
- 12个球型中成功7个（58%）
- 总分达到90分
- 技术动作规范
- 展现稳定心态',
        'steps', ARRAY[
            '第一部分：角度球测试（4个）',
            '  - 30度向边球',
            '  - 45度离边球',
            '  - 60度角度球',
            '  - 75度薄切球',
            '第二部分：中袋球测试（3个）',
            '  - 直线中袋（50cm）',
            '  - 15度斜中袋',
            '  - 25度大角中袋',
            '第三部分：极限高球测试（2个）',
            '  - 80度极限角',
            '  - 85度超薄切',
            '第四部分：特殊技术测试（2个）',
            '  - 白球贴库击球',
            '  - 目标球贴库瞄准',
            '第五部分：综合球型（1个）',
            '  - 自选角度的高难度球',
            '  - 展现最佳技术水平'
        ],
        'tips', ARRAY[
            '测试前充分热身，确保状态最佳',
            '按顺序完成测试，不要跳跃',
            '每个球型有2次机会，取最好成绩',
            '失败不要灰心，专注下一个',
            '重点展现技术规范性',
            '时间充足，不要急躁',
            '相信自己的训练成果'
        ],
        'common_mistakes', ARRAY[
            '心理压力过大影响发挥',
            '过度追求成功率忽视技术规范',
            '失误后心态崩溃',
            '时间分配不当',
            '没有充分试杆',
            '瞄准锁定失效'
        ],
        'practice_requirements', '完成12个测试球型，每个球型有2次机会，记录成功数、得分和技术表现',
        'success_criteria', '12个球型中成功7个（58%），总分达到90分，展现Level 7的技术水平和心理素质',
        'related_courses', ARRAY[19, 20, 21, 22, 23, 41]
    ),
    30,
    30
FROM sub_skills ss
JOIN training_skills s ON ss.skill_id = s.id
WHERE s.skill_name = '高级技术' AND ss.sub_skill_name = '瞄准技术精进'
ON CONFLICT DO NOTHING;

-- 提交事务
COMMIT;

-- ============================================================================
-- 验证导入结果
-- ============================================================================

DO $$
DECLARE
    unit_count INTEGER;
    subskill1_count INTEGER;
    subskill2_count INTEGER;
BEGIN
    -- 统计Level 7总单元数
    SELECT COUNT(*) INTO unit_count
    FROM training_units tu
    JOIN sub_skills ss ON tu.sub_skill_id = ss.id
    JOIN training_skills s ON ss.skill_id = s.id
    WHERE s.skill_name = '高级技术';

    -- 统计各子技能单元数
    SELECT COUNT(*) INTO subskill1_count
    FROM training_units tu
    JOIN sub_skills ss ON tu.sub_skill_id = ss.id
    WHERE ss.sub_skill_name = '特殊技术掌握';

    SELECT COUNT(*) INTO subskill2_count
    FROM training_units tu
    JOIN sub_skills ss ON tu.sub_skill_id = ss.id
    WHERE ss.sub_skill_name = '瞄准技术精进';

    -- 输出验证结果
    RAISE NOTICE '===========================================';
    RAISE NOTICE 'Level 7 训练单元导入验证';
    RAISE NOTICE '===========================================';
    RAISE NOTICE 'Level 7 总单元数: %', unit_count;
    RAISE NOTICE '  - 子技能 7.1 (特殊技术掌握): % 个单元', subskill1_count;
    RAISE NOTICE '  - 子技能 7.2 (瞄准技术精进): % 个单元', subskill2_count;
    RAISE NOTICE '===========================================';

    IF unit_count = 6 THEN
        RAISE NOTICE '✅ Level 7 导入成功！';
    ELSE
        RAISE WARNING '⚠️  Level 7 导入不完整，期望6个单元，实际%个', unit_count;
    END IF;
END $$;

-- ============================================================================
-- 查询Level 7训练单元详细信息
-- ============================================================================

SELECT
    s.skill_name AS "技能",
    ss.sub_skill_name AS "子技能",
    tu.unit_order AS "顺序",
    tu.title AS "单元标题",
    tu.unit_type AS "类型",
    tu.xp_reward AS "经验值",
    tu.estimated_minutes AS "时长(分钟)"
FROM training_units tu
JOIN sub_skills ss ON tu.sub_skill_id = ss.id
JOIN training_skills s ON ss.skill_id = s.id
WHERE s.skill_name = '高级技术'
ORDER BY ss.sub_skill_order, tu.unit_order;

-- ============================================================================
-- 使用说明
-- ============================================================================
--
-- 执行顺序:
-- 1. 确保已执行 11_create_subskills_level4_8.sql 创建子技能
-- 2. 执行本脚本导入Level 7训练单元
-- 3. 执行 10_insert_level8_units.sql 导入Level 8
--
-- 回滚方法:
-- DELETE FROM training_units
-- WHERE sub_skill_id IN (
--   SELECT ss.id FROM sub_skills ss
--   JOIN training_skills s ON ss.skill_id = s.id
--   WHERE s.skill_name = '高级技术'
-- );
--
-- 注意事项:
-- - 使用 ON CONFLICT DO NOTHING 避免重复插入
-- - JSONB content字段包含完整训练内容
-- - related_courses映射到52集王猛课程
-- ============================================================================
